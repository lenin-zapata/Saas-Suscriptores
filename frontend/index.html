<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS MemberLy - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }

        /* Sidebar nav active / hover */
        .nav-link { transition: all 0.2s ease; }
        .nav-link.active  { background: rgba(255,255,255,0.15); color:#fff; }
        .nav-link:hover:not(.active) { background: rgba(255,255,255,0.08); }

        /* Subtle animated gradient on login */
        .login-bg {
            background: linear-gradient(135deg, #065f46 0%, #047857 40%, #059669 70%, #10b981 100%);
            background-size: 300% 300%;
            animation: gradientShift 8s ease infinite;
        }
        @keyframes gradientShift {
            0%   { background-position: 0% 50%; }
            50%  { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* KPI card hover lift */
        .kpi-card { transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }

        /* Table row transitions */
        tbody tr { transition: background 0.15s; }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1fae5; border-radius: 99px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">

    <div id="pantallaLogin" class="w-full h-full flex items-center justify-center login-bg fixed z-50">

        <div class="absolute top-0 left-0 w-72 h-72 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
        <div class="absolute bottom-0 right-0 w-96 h-96 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3 pointer-events-none"></div>

        <div class="relative bg-white rounded-3xl shadow-2xl w-[420px] max-w-[calc(100vw-2rem)] overflow-hidden">
            <div class="bg-emerald-600 px-10 pt-10 pb-8 text-center">
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
                <h1 class="text-2xl font-extrabold text-white tracking-tight">JS MemberLy</h1>
                <p class="text-emerald-100 text-sm mt-1">Panel de Administraci√≥n</p>
            </div>

            <form id="formLogin" class="px-10 py-8 flex flex-col gap-5">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Correo Electr√≥nico</label>
                    <input type="email" id="emailLogin" required
                        class="w-full border border-gray-200 bg-gray-50 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 outline-none transition text-sm"
                        placeholder="admin@irongym.com">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Contrase√±a</label>
                    <input type="password" id="passLogin" required
                        class="w-full border border-gray-200 bg-gray-50 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 outline-none transition text-sm"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit"
                    class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-200 mt-1 text-sm">
                    Ingresar al Sistema
                </button>

                <div class="text-center">
                    <button type="button" onclick="solicitarResetPassword()"
                        class="text-xs text-emerald-600 hover:text-emerald-800 font-semibold transition underline underline-offset-4">
                        ¬øOlvidaste tu contrase√±a?
                    </button>
                </div>

                <div class="border-t border-gray-100 pt-5 text-center">
                    <p class="text-xs text-gray-400 mb-2">¬øEres personal nuevo?</p>
                    <button type="button" onclick="abrirRegistro()"
                        class="text-sm text-emerald-600 hover:text-emerald-800 font-bold transition">
                        Crear mi cuenta de acceso
                    </button>
                </div>

                <p id="errorLogin" class="text-red-500 text-xs text-center hidden font-medium bg-red-50 py-2 px-3 rounded-lg"></p>
            </form>
        </div>
    </div>

    <div id="pantallaDashboard" class="flex w-full h-full hidden">

        <aside class="w-64 bg-emerald-900 text-white flex flex-col shadow-2xl z-10 shrink-0">

            <div class="p-6 flex flex-col items-center border-b border-white/10 text-center">
                <div class="relative group cursor-pointer w-20 h-20 rounded-2xl bg-white/10 flex items-center justify-center overflow-hidden mb-3 border border-white/20 shadow-inner">
                    <img id="logoGymImg" src="https://via.placeholder.com/150?text=Logo" alt="Logo Gym" class="w-full h-full object-cover">
                    <label for="uploadLogo" class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer text-[10px] text-white gap-1">
                        <span class="text-lg">üì∑</span><span>Cambiar</span>
                    </label>
                    <input type="file" id="uploadLogo" class="hidden" accept="image/*" onchange="subirLogo(this)">
                </div>
                <h2 id="nombreGymSidebar" class="text-sm font-bold tracking-wide text-white">Cargando...</h2>
            </div>

            <nav class="flex-1 p-4 flex flex-col gap-1">
                <a href="#" onclick="cambiarVista('resumen')" id="btnNavDashboard"
                    class="nav-link active flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold">
                    <span class="text-base">üìä</span> Dashboard
                </a>
                <a href="#" onclick="cambiarVista('staff')" id="btnNavStaff"
                    class="solo-admin nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-white/70">
                    <span class="text-base">üë•</span> Gestionar Staff
                </a>
                <a href="#" onclick="cambiarVista('finanzas')" id="btnMenuFinanzas" class="solo-admin nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-white/70">
                    <span>üìä</span> <span class="font-medium">Finanzas</span>
                    <span class="ml-auto text-[10px] bg-yellow-400 text-yellow-900 font-bold px-2 py-0.5 rounded-full uppercase">Elite</span>
                </a>
                <a onclick="cambiarVista('escanear')"
                    class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-white/70 cursor-pointer">
                    <span class="text-base">üì∑</span> Escanear Pase
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <button onclick="cerrarSesion()"
                    class="w-full flex items-center justify-center gap-2 text-white/50 hover:text-white px-4 py-2 rounded-xl text-sm transition font-medium">
                    <span>üö™</span> Cerrar Sesi√≥n
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-y-auto bg-gray-50">

            <header class="bg-white border-b border-gray-100 px-8 py-4 flex justify-between items-center sticky top-0 z-40">
                <div>
                    <h1 class="text-xl font-extrabold text-gray-900 tracking-tight">Resumen General</h1>
                    <p class="text-xs text-gray-400 font-medium mt-0.5">Panel de control de tu gimnasio</p>
                </div>
                <div class="relative group">
                    <button class="flex items-center gap-3 hover:bg-gray-50 p-2 rounded-2xl transition">
                        <div id="userInitialsCircle"
                            class="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center text-emerald-700 font-extrabold border-2 border-white shadow-sm text-sm">A</div>
                        <div class="text-left hidden md:block">
                            <p id="userNameDisplay" class="text-sm font-bold text-gray-800 leading-none">Usuario</p>
                            <p class="text-[10px] text-gray-400 font-semibold uppercase mt-1">Mi Cuenta ‚ñº</p>
                        </div>
                    </button>
                    <div class="absolute right-0 w-48 mt-1 bg-white rounded-2xl shadow-xl border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                        <div class="p-2">
                            <button onclick="document.getElementById('modalPassword').classList.remove('hidden')"
                                class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-600 hover:bg-emerald-50 hover:text-emerald-700 rounded-xl transition">üîê Nueva Clave</button>
                            <div class="border-t border-gray-100 my-1"></div>
                            <button onclick="cerrarSesion()"
                                class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-500 hover:bg-red-50 rounded-xl font-semibold transition">üö™ Salir</button>
                        </div>
                    </div>
                </div>
            </header>

            <div id="vistaResumen" class="p-8 space-y-6">

                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">

                    <div class="solo-admin kpi-card bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex flex-col gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-2xl bg-emerald-50 flex items-center justify-center text-2xl shrink-0">üë•</div>
                            <div>
                                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Clientes Activos</p>
                                <h3 class="text-3xl font-extrabold text-gray-900 leading-none mt-1">
                                    <span id="kpiTotal">0</span>
                                    <span class="text-base text-gray-300 font-semibold"> / <span id="kpiLimite">100</span></span>
                                </h3>
                            </div>
                        </div>
                        <div>
                            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                <div id="barraUsoPlan" class="bg-emerald-500 h-2 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                            <div class="flex justify-between items-center mt-2.5">
                                <p class="text-[11px] text-gray-400 font-semibold">Plan <span id="nombrePlanSaas" class="capitalize font-extrabold text-emerald-600">Starter</span></p>
                                <button onclick="prepararYAbrirModalUpgrade()"
                                    class="text-[11px] bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg font-bold hover:bg-emerald-100 transition flex items-center gap-1">
                                    üöÄ Subir de Nivel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="solo-admin kpi-card bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-emerald-50 flex items-center justify-center text-2xl shrink-0">‚úÖ</div>
                        <div>
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Al D√≠a</p>
                            <h3 id="kpiAlDia" class="text-3xl font-extrabold text-emerald-600 leading-none mt-1">0</h3>
                        </div>
                    </div>

                    <div class="solo-admin kpi-card bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-red-50 flex items-center justify-center text-2xl shrink-0">‚ö†Ô∏è</div>
                        <div>
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Atrasados</p>
                            <h3 id="kpiMorosos" class="text-3xl font-extrabold text-red-500 leading-none mt-1">0</h3>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

                    <div class="lg:col-span-2 bg-white rounded-3xl border border-gray-100 shadow-sm p-6">
                        <h2 class="text-base font-extrabold text-gray-800 mb-5 flex items-center gap-2">
                            <span class="w-7 h-7 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm">‚ûï</span>
                            Registrar Nuevo Suscriptor
                        </h2>
                        <form id="formSuscriptor" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Nombre</label>
                                <input type="text" id="nombre" required placeholder="Nombre y Apellido"
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">WhatsApp</label>
                                <input type="text" id="telefono" required placeholder="+593..."
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Email</label>
                                <input type="email" id="email" required placeholder="test@example.com"
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Contacto de Emergencia</label>
                                <input type="text" id="contactoEmergencia" required placeholder="Tel√©fono de contacto"
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition">
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Plan</label>
                                <select id="planElegido" required
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Foto del Cliente</label>
                                <input type="file" id="fotoInput" accept="image/*" required
                                    class="w-full border border-gray-200 bg-gray-50 p-1.5 rounded-xl text-sm file:mr-4 file:py-1.5 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200 transition cursor-pointer">
                            </div>
                            
                            <div class="md:col-span-2 mt-2">
                                <button type="submit"
                                    class="px-8 py-2.5 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 text-sm">
                                    Guardar Cliente
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="solo-admin bg-white rounded-3xl border border-gray-100 shadow-sm p-6 flex flex-col">
                        <h2 class="text-base font-extrabold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="w-7 h-7 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm">üìä</span>
                            Estado de Pagos
                        </h2>
                        <div class="flex-1 flex items-center justify-center min-h-[180px]">
                            <canvas id="graficoPagos"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="px-6 py-5 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 class="text-base font-extrabold text-gray-800 flex items-center gap-2">
                            <span class="w-7 h-7 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm">üìã</span>
                            Directorio de Clientes
                        </h2>
                        <div class="relative w-full md:w-72">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-300 text-sm">üîç</span>
                            <input type="text" id="inputBuscarCliente" onkeyup="filtrarClientes()"
                                class="w-full pl-9 pr-4 py-2 border border-gray-200 bg-gray-50 rounded-xl text-sm focus:ring-2 focus:ring-emerald-400 outline-none transition"
                                placeholder="Buscar por nombre o email...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b border-gray-100">
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-widest">Nombre</th>
                                    <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-400 uppercase tracking-widest">Contacto</th>
                                    <th class="px-6 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="tablaCuerpo" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>

            </div>
            
            <div id="vistaFinanzas" class="hidden px-8 pb-8 pt-2 relative min-h-[600px] max-w-5xl mx-auto w-full">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center md:text-left">Reportes Financieros Avanzados</h2>

                <div id="paywallFinanzas" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-white/70 backdrop-blur-md rounded-2xl">
                    <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md border border-indigo-50 mx-4">
                        <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">üîí</div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Exclusivo del Plan Elite</h3>
                        <p class="text-gray-500 text-sm mb-6 leading-relaxed">Desbloquea proyecciones de flujo de caja, an√°lisis de retenci√≥n y m√©tricas de ingresos recurrentes para escalar tu negocio.</p>
                        <button onclick="prepararYAbrirModalUpgrade()" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl hover:bg-black transition shadow-md flex justify-center items-center gap-2">
                            Desbloquear Finanzas üöÄ
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pb-10 items-start">
                    
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center h-full">
                        <p class="text-sm text-gray-500 font-medium mb-2 uppercase tracking-wider">Ingreso Recurrente Mensual (MRR)</p>
                        <h3 class="text-5xl font-extrabold text-emerald-600 mb-3 tracking-tight">$<span id="kpiMRR">0.00</span></h3>
                        <p class="text-xs text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-full font-bold inline-flex items-center gap-1">
                            <span>üìà</span> +12% vs mes anterior
                        </p>
                    </div>

                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center h-full">
                        <p class="text-sm text-gray-500 font-medium mb-2 uppercase tracking-wider">Tasa de Retenci√≥n Anual</p>
                        <h3 class="text-5xl font-extrabold text-indigo-600 mb-3 tracking-tight"><span id="kpiRetencion">0</span>%</h3>
                        <p class="text-xs text-red-700 bg-red-50 px-3 py-1.5 rounded-full font-bold inline-flex items-center gap-1">
                            <span>üìâ</span> Tasa de abandono: <span id="kpiChurn">0</span>%
                        </p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                        <h3 class="text-base font-bold text-gray-800 mb-6 text-center md:text-left">Proyecci√≥n de Flujo de Caja (15 d√≠as)</h3>
                        <div class="relative h-72 w-full">
                            <canvas id="graficoFlujoCaja"></canvas>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                        <h3 class="text-base font-bold text-gray-800 mb-6 text-center md:text-left">Distribuci√≥n de Ingresos</h3>
                        <div class="relative h-72 w-full flex justify-center">
                            <canvas id="graficoPlanes"></canvas>
                        </div>
                    </div>

                </div>
            </div>

            <div id="vistaStaff" class="hidden p-8 w-full max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-extrabold text-gray-900 tracking-tight">Gestionar Personal</h2>
                        <p class="text-xs text-gray-400 font-medium mt-1">Administra los accesos de tu equipo</p>
                    </div>
                    <button onclick="document.getElementById('modalNuevoStaff').classList.remove('hidden')"
                        class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-emerald-100 hover:bg-emerald-700 transition text-sm">
                        + Nuevo Miembro
                    </button>
                </div>
                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-100">
                                <th class="px-6 py-4 text-left text-[10px] font-bold text-gray-400 uppercase tracking-widest">Nombre</th>
                                <th class="px-6 py-4 text-left text-[10px] font-bold text-gray-400 uppercase tracking-widest">Rol</th>
                                <th class="px-6 py-4 text-right text-[10px] font-bold text-gray-400 uppercase tracking-widest">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaStaff" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <div id="vistaEscanear" class="hidden p-8 w-full max-w-6xl mx-auto">
                <h2 class="text-2xl font-extrabold text-gray-900 tracking-tight mb-1">Escanear Pase</h2>
                <p class="text-xs text-gray-400 font-medium mb-8">Verifica el acceso de tus clientes con c√≥digo QR</p>
                
                <div class="bg-white p-10 rounded-3xl border border-gray-100 shadow-sm text-center max-w-lg mx-auto flex flex-col items-center">
                    <div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-4xl mb-6">üì∑</div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Lector de Accesos</h3>
                    <p class="text-sm text-gray-500 mb-8">Usa la c√°mara de tu dispositivo para leer el c√≥digo QR del pase del cliente.</p>
                    <button onclick="abrirEscanner()" class="w-full bg-emerald-600 text-white font-bold py-3.5 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100">
                        Activar C√°mara y Escanear
                    </button>
                </div>
            </div>

        </main>
    </div>

    <div id="modalPassword" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm border border-gray-100">
            <h2 class="text-lg font-extrabold mb-1 text-gray-900">üîí Actualizar Contrase√±a</h2>
            <p class="text-xs text-gray-400 mb-6">M√≠nimo 6 caracteres.</p>
            <form id="formUpdatePassword" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Nueva Clave</label>
                    <input type="password" id="newPassword" required minlength="6"
                        class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm">
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition text-sm">Guardar Cambios</button>
                <button type="button" onclick="cancelarReset()" class="text-gray-400 text-xs text-center hover:text-gray-600 transition">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="modalNuevoStaff" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border border-gray-100">
            <h2 class="text-lg font-extrabold mb-1 text-gray-900">‚ûï Agregar Personal</h2>
            <p class="text-xs text-gray-400 mb-6">Se enviar√° una invitaci√≥n por WhatsApp.</p>
            <form id="formNuevoStaff" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Nombre</label>
                    <input type="text" id="nombreStaff" required class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Email</label>
                    <input type="email" id="emailStaff" required class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Tel√©fono (WhatsApp)</label>
                    <input type="text" id="telefonoStaff" required class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm" placeholder="+593...">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Rol</label>
                    <select id="rolStaff" class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm">
                        <option value="recepcionista">Recepcionista</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="flex gap-3 mt-2">
                    <button type="submit" class="flex-1 bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-100 transition text-sm">Registrar</button>
                    <button type="button" onclick="document.getElementById('modalNuevoStaff').classList.add('hidden')"
                        class="px-5 text-gray-400 font-semibold text-sm hover:text-gray-600 transition">Cerrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalQR" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden max-w-sm w-full mx-4 border border-gray-100">
            <div class="bg-emerald-700 p-6 text-center relative">
                <button onclick="document.getElementById('modalQR').classList.add('hidden')"
                    class="absolute top-4 right-4 text-emerald-200 hover:text-white text-lg transition">‚úï</button>
                
                <img id="fotoClienteQR" src="" alt="Foto Cliente" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover border-4 border-emerald-500 shadow-md bg-white">
                
                <h2 class="text-lg font-extrabold text-white">Pase de Acceso</h2>
                <p id="nombreClienteQR" class="text-emerald-200 text-sm mt-1"></p>
            </div>
            <div class="p-8 flex flex-col items-center gap-6">
                <div id="contenedorQR" class="p-4 bg-white border border-gray-100 rounded-2xl shadow-inner"></div>
                <button id="btnEnviarWA"
                    class="w-full bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-3.5 rounded-2xl shadow-lg transition text-sm">
                    üì≤ Enviar por WhatsApp
                </button>
            </div>
        </div>
    </div>

    <div id="modalExitoCliente" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border border-emerald-100 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-emerald-500"></div>
            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-4xl mx-auto mb-4 shadow-inner">üéâ</div>
            <h2 class="text-2xl font-extrabold text-gray-900 mb-2">¬°Cliente Registrado!</h2>
            <p class="text-gray-500 text-sm mb-6">El suscriptor ha sido guardado exitosamente.</p>
            
            <div class="bg-gray-50 rounded-2xl p-5 mb-6 text-left border border-gray-100 space-y-3">
                <p class="text-sm"><span class="font-bold text-gray-700">Nombre:</span> <span id="resNombre" class="text-gray-600"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-700">WhatsApp:</span> <span id="resTelefono" class="text-gray-600"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-700">Email:</span> <span id="resEmail" class="text-gray-600"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-700">Emergencia:</span> <span id="resEmergencia" class="text-gray-600"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-700">Plan:</span> <span id="resPlan" class="text-gray-600 font-bold text-emerald-600"></span></p>
            </div>

            <button onclick="document.getElementById('modalExitoCliente').classList.add('hidden')" class="w-full bg-emerald-600 text-white font-bold py-3.5 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 text-sm">
                Genial, continuar üëç
            </button>
        </div>
    </div>

    <div id="lectorQRContainer" class="fixed inset-0 bg-black/80 hidden z-[70] flex items-center justify-center">
        <div class="bg-white p-6 rounded-3xl w-full max-w-md text-center border border-gray-100">
            <div id="reader"></div>
            <button onclick="cerrarEscanner()"
                class="w-full mt-4 p-2.5 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-sm transition">Cancelar</button>
        </div>
    </div>

    <div id="modalRegistro" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm border border-gray-100">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center text-xl mx-auto mb-3">üìù</div>
                <h2 class="text-lg font-extrabold text-gray-900">Activar Cuenta</h2>
                <p class="text-xs text-gray-400 mt-1">Usa el correo exacto con el que el administrador te registr√≥.</p>
            </div>
            <form id="formRegistro" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Correo Electr√≥nico</label>
                    <input type="email" id="emailRegistro" required
                        class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm" placeholder="tu_correo@gym.com">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Crea una Contrase√±a</label>
                    <input type="password" id="passRegistro" required minlength="6"
                        class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm" placeholder="M√≠nimo 6 caracteres">
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 mt-2 text-sm">
                    Crear Cuenta
                </button>
                <button type="button" onclick="cerrarRegistro()" class="text-gray-400 text-xs text-center hover:text-gray-600 transition">
                    Cancelar y volver al Login
                </button>
            </form>
        </div>
    </div>

    <div id="modalUpgrade" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg text-center border border-emerald-100">
            <div class="w-20 h-20 bg-emerald-50 rounded-3xl flex items-center justify-center mx-auto mb-4 border-4 border-emerald-100 text-4xl">üöÄ</div>
            <h2 class="text-2xl font-extrabold mb-2 text-gray-900">¬°Tu gimnasio est√° creciendo!</h2>
            <p class="text-gray-500 text-sm mb-6 leading-relaxed">
                Est√°s alcanzando el l√≠mite de clientes de tu plan actual.<br>
                Es momento de subir de nivel y desbloquear m√°s herramientas.
            </p>
            <div class="bg-gray-50 rounded-2xl p-6 mb-6 text-left border border-gray-100">
                <h3 id="tituloPlanUpsell" class="font-extrabold text-gray-900 mb-3 text-base">Cargando plan...</h3>
                <ul id="listaFeaturesUpsell" class="text-sm text-gray-600 space-y-2"></ul>
            </div>
            <div class="flex gap-3">
                <button id="btnPagarUpgrade" onclick="iniciarPagoUpgrade()"
                    class="flex-1 bg-emerald-600 text-white font-bold py-3.5 rounded-2xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 flex justify-center items-center gap-2 text-sm">
                    Mejorar Plan <span>üí≥</span>
                </button>
                <button onclick="document.getElementById('modalUpgrade').classList.add('hidden')"
                    class="px-6 text-gray-400 font-semibold hover:text-gray-600 transition text-sm">
                    Quiz√°s luego
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kfqdefzuwejwmupgvelg.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWRlZnp1d2Vqd211cGd2ZWxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MTcwMzYsImV4cCI6MjA4Njk5MzAzNn0.Wdr14R9gZ6Osy8RrVaYXC6CKUtBoYqbE9tV3oiekCPE';
        const API_URL = "http://localhost:8787/suscriptores";
        const API_PLANES = "http://localhost:8787/planes";
        
        const miSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let tokenActual = null;
        let miTenantId = null; 
        let graficoInstancia = null;
        let modoRecuperacion = false;
        let listaClientesOriginal = [];

        let limiteClientesActual = 100;
        let planSaasActual = 'starter';
        let totalClientesActual = 0;

        // LOGIN
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const errorMsg = document.getElementById('errorLogin');
            btn.innerHTML = 'Cargando...'; btn.disabled = true; errorMsg.classList.add('hidden');

            try {
                const email = document.getElementById('emailLogin').value;
                const password = document.getElementById('passLogin').value;

                const { data, error: authError } = await miSupabase.auth.signInWithPassword({ email, password });
                if (authError) throw authError;

                tokenActual = data.session.access_token;
                const userEmail = data.session.user.email;
                const userId = data.session.user.id;

                let { data: staffData } = await miSupabase
                    .from('perfiles_staff')
                    .select('*')
                    .or(`id.eq.${userId},email.eq.${userEmail}`);

                if (staffData && staffData.length > 0) {
                    const perfil = staffData[0];
                    miTenantId = perfil.tenant_id;
                    
                    if (perfil.id !== userId) {
                        await miSupabase.from('perfiles_staff').update({ id: userId }).eq('email', userEmail);
                    }

                    document.getElementById('userNameDisplay').innerText = perfil.nombre;
                    document.getElementById('userInitialsCircle').innerText = perfil.nombre.charAt(0).toUpperCase();
                    aplicarPermisos(perfil.rol);

                    const { data: negocio } = await miSupabase.from('tenants').select('*').eq('id', miTenantId).single();
                    if (negocio) {
                        document.getElementById('nombreGymSidebar').innerText = negocio.nombre_negocio;
                        if (negocio.logo_url) document.getElementById('logoGymImg').src = negocio.logo_url;
                        planSaasActual = negocio.plan_saas || 'starter';
                        limiteClientesActual = negocio.limite_clientes || 100;
                        if (negocio.estado_suscripcion !== 'activa') {
                            alert("‚ö†Ô∏è La suscripci√≥n de tu gimnasio est√° inactiva. Funcionalidades limitadas.");
                        }
                    }

                    document.getElementById('pantallaLogin').classList.add('hidden');
                    document.getElementById('pantallaDashboard').classList.remove('hidden');
                    await cargarPlanes();
                    await cargarDatosYDashboard();
                } else {
                    throw new Error("No tienes un perfil asignado en este sistema.");
                }
            } catch (err) {
                console.error(err);
                errorMsg.innerText = "Error: " + err.message;
                errorMsg.classList.remove('hidden');
            } finally {
                btn.innerHTML = 'Ingresar al Sistema'; btn.disabled = false;
            }
        });

        // NAVEGACI√ìN Y CARGA DE STAFF
        async function cargarStaff() {
            if (!miTenantId) return;
            const { data: staff } = await miSupabase.from('perfiles_staff').select('*').eq('tenant_id', miTenantId).order('nombre');
            if (staff) {
                document.getElementById('tablaStaff').innerHTML = staff.map(s => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 font-semibold text-sm text-gray-800">
                            ${s.nombre}
                            <br><span class="text-[10px] text-gray-400 font-normal">${s.email || 'Pendiente'}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded-lg text-[10px] font-bold ${s.rol === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-emerald-100 text-emerald-700'}">
                                ${s.rol.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            ${s.rol !== 'admin'
                                ? `<button onclick="eliminarStaff('${s.id}')" class="text-red-500 hover:text-red-700 text-sm font-bold transition">Eliminar</button>`
                                : `<span class="text-gray-300 text-xs italic">Protegido</span>`}
                        </td>
                    </tr>
                `).join('');
            }
        }

        document.getElementById('formNuevoStaff').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Guardando...'; btn.disabled = true;

            const nombre = document.getElementById('nombreStaff').value;
            const email = document.getElementById('emailStaff').value;
            const telefono = document.getElementById('telefonoStaff').value;
            const rol = document.getElementById('rolStaff').value;

            try {
                const { error: dbError } = await miSupabase
                    .from('perfiles_staff')
                    .insert([{ tenant_id: miTenantId, nombre, email, telefono, rol }]);
                if (dbError) throw dbError;

                const urlRegistro = window.location.href.split('#')[0]; 
                const mensaje = `Hola ${nombre}, te he agregado al equipo de JS MemberLy. \n\nPor favor, ingresa a ${urlRegistro} y haz clic en "Crear mi cuenta de acceso" usando exactamente este correo: ${email}`;
                const numeroWA = telefono.replace(/\D/g, ''); 

                alert("‚úÖ Perfil creado. Se abrir√° WhatsApp para enviar las instrucciones.");
                window.open(`https://wa.me/${numeroWA}?text=${encodeURIComponent(mensaje)}`, '_blank');

                document.getElementById('modalNuevoStaff').classList.add('hidden');
                e.target.reset();
                cargarStaff();
            } catch (err) {
                alert("‚ùå Error: " + err.message);
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        });

        // PLANES & DASHBOARD
        async function cargarPlanes() {
            const res = await fetch(API_PLANES, { headers: { 'Authorization': `Bearer ${tokenActual}` } });
            const planes = await res.json();
            const select = document.getElementById('planElegido');
            select.innerHTML = planes.map(p => {
                let meses = p.nombre_plan.toLowerCase().includes('anual') ? 12 : (p.nombre_plan.toLowerCase().includes('trimestral') ? 3 : 1);
                return `<option value="${p.id}" data-meses="${meses}">${p.nombre_plan}</option>`;
            }).join('');
        }

        async function cargarDatosYDashboard() {
            try {
                const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${tokenActual}` } });
                let clientesCrudos = await res.json();
                
                const clientes = clientesCrudos.filter(c => c.tenant_id === miTenantId);
                
                listaClientesOriginal = clientes; 
                renderizarTablaClientes(clientes); 

                totalClientesActual = clientes.length;
                document.getElementById('kpiTotal').innerText = totalClientesActual;
                document.getElementById('kpiLimite').innerText = limiteClientesActual;

                const barra = document.getElementById('barraUsoPlan');
                const nombrePlan = document.getElementById('nombrePlanSaas');
                if (barra) {
                    let porcentajeUso = limiteClientesActual > 0 
                        ? (totalClientesActual / limiteClientesActual) * 100 
                        : 0;
                    if (porcentajeUso > 100) porcentajeUso = 100;
                    barra.style.width = `${porcentajeUso}%`;
                    barra.className = `transition-all duration-700 h-2 rounded-full ${porcentajeUso >= 90 ? 'bg-red-500' : 'bg-emerald-500'}`;
                }
                if (nombrePlan) nombrePlan.innerText = planSaasActual;

                // Pagos desde historial_suscripciones
                const { data: historial, error: histError } = await miSupabase
                    .from('historial_suscripciones')
                    .select('suscriptor_id, estado_pago')
                    .eq('tenant_id', miTenantId);

                let contAlDia = 0;
                let contAtrasados = 0;

                if (historial && !histError) {
                    historial.forEach(h => {
                        if (h.estado_pago === 'Pagado') contAlDia++;
                        else if (h.estado_pago === 'Atrasado') contAtrasados++;
                    });
                }

                const elementoAlDia = document.getElementById('kpiAlDia');
                const elementoAtrasados = document.getElementById('kpiMorosos');
                if (elementoAlDia) elementoAlDia.innerText = contAlDia;
                if (elementoAtrasados) elementoAtrasados.innerText = contAtrasados;
                
                actualizarGrafico(contAlDia, contAtrasados);

            } catch (error) { 
                console.error("Error al cargar el dashboard:", error); 
            }
        }

        function actualizarGrafico(alDia, morosos) {
            const ctx = document.getElementById('graficoPagos').getContext('2d');
            if (graficoInstancia) graficoInstancia.destroy();
            graficoInstancia = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Al D√≠a', 'Atrasados'],
                    datasets: [{ data: [alDia, morosos], backgroundColor: ['#10B981', '#EF4444'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '72%' }
            });
        }

        // PERMISOS
        function aplicarPermisos(rol) {
            document.querySelectorAll('.solo-admin').forEach(el =>
                rol === 'recepcionista' ? el.classList.add('hidden') : el.classList.remove('hidden')
            );
        }

        async function subirLogo(input) {
            const archivo = input.files[0];
            if (!archivo) return;

            // --- NUEVA VALIDACI√ìN DE TAMA√ëO (1 MB) ---
            if (archivo.size > 1048576) {
                alert("‚ö†Ô∏è El archivo es demasiado grande. Por favor, sube un logo que pese menos de 1 MB.");
                input.value = ''; // Limpiamos el input para que pueda intentar de nuevo
                return;
            }

            const imgElement = document.getElementById('logoGymImg');
            imgElement.src = "https://via.placeholder.com/150?text=Subiendo...";
            try {
                const fileName = `${miTenantId}/logo_${Date.now()}.png`;
                await miSupabase.storage.from('logos').upload(fileName, archivo);
                const { data: urlData } = miSupabase.storage.from('logos').getPublicUrl(fileName);
                await miSupabase.from('tenants').update({ logo_url: urlData.publicUrl }).eq('id', miTenantId);
                imgElement.src = urlData.publicUrl;
            } catch (e) { alert("Error al subir"); }
        }

        async function eliminarStaff(id) {
            if (confirm("¬øEliminar este miembro del equipo?")) {
                await miSupabase.from('perfiles_staff').delete().eq('id', id);
                cargarStaff();
            }
        }

        function mostrarPaseQR(id, nombre, tel, fotoUrl) {
            document.getElementById('modalQR').classList.remove('hidden');
            document.getElementById('nombreClienteQR').innerText = nombre;
            
            // L√≥gica de la Foto: Si no tiene, creamos un avatar con sus iniciales autom√°ticamente
            const imgEl = document.getElementById('fotoClienteQR');
            if (fotoUrl && fotoUrl !== 'null' && fotoUrl !== '') {
                imgEl.src = fotoUrl;
            } else {
                imgEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=10B981&color=fff&size=150`;
            }

            const cont = document.getElementById('contenedorQR'); 
            cont.innerHTML = '';
            new QRCode(cont, { text: `https://wide-waves-shave.loca.lt/checkin/${id}`, width: 220, height: 220 });
            
            document.getElementById('btnEnviarWA').onclick = () =>
                window.open(`https://wa.me/${tel.replace(/\D/g,'')}?text=Hola ${nombre}, aqu√≠ tienes tu pase QR de acceso al gimnasio.`, '_blank');
        }

        let html5QrCode;
        function abrirEscanner() {
            document.getElementById('lectorQRContainer').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                html5QrCode.stop().then(() => window.location.href = txt);
            });
        }
        function cerrarEscanner() {
            if (html5QrCode) html5QrCode.stop().then(() => document.getElementById('lectorQRContainer').classList.add('hidden'));
            else document.getElementById('lectorQRContainer').classList.add('hidden');
        }

        document.getElementById('formUpdatePassword').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { error } = await miSupabase.auth.updateUser({ password: document.getElementById('newPassword').value });
            if (!error) { alert("‚úÖ Contrase√±a actualizada."); await miSupabase.auth.signOut(); location.reload(); }
            else alert("Error: " + error.message);
        });

        miSupabase.auth.onAuthStateChange((event, session) => {
            if (event === "PASSWORD_RECOVERY") {
                modoRecuperacion = true;
                document.getElementById('pantallaLogin').classList.add('hidden');
                document.getElementById('modalPassword').classList.remove('hidden');
                alert("üëã ¬°Bienvenido al equipo! Por favor, crea tu nueva contrase√±a para activar tu cuenta.");
            }
        });

        function cancelarReset() {
            document.getElementById('modalPassword').classList.add('hidden');
            if (modoRecuperacion) { miSupabase.auth.signOut(); location.reload(); }
        }
        async function solicitarResetPassword() {
            const email = document.getElementById('emailLogin').value;
            if (!email) return alert("‚ö†Ô∏è Ingresa tu correo primero.");
            const { error } = await miSupabase.auth.resetPasswordForEmail(email, { redirectTo: 'http://127.0.0.1:5500/frontend/index.html' });
            if (!error) alert("üì© Enlace enviado.");
        }
        function cerrarSesion() { miSupabase.auth.signOut(); location.reload(); }

        function abrirRegistro() {
            document.getElementById('modalRegistro').classList.remove('hidden');
            document.getElementById('pantallaLogin').classList.add('hidden');
        }
        function cerrarRegistro() {
            document.getElementById('modalRegistro').classList.add('hidden');
            document.getElementById('pantallaLogin').classList.remove('hidden');
        }

        document.getElementById('formRegistro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Verificando...'; btn.disabled = true;

            const email = document.getElementById('emailRegistro').value;
            const password = document.getElementById('passRegistro').value;

            try {
                const { data: estaAutorizado, error: rpcError } = await miSupabase.rpc('verificar_invitacion', { correo: email });
                if (rpcError) throw new Error("Error al consultar el directorio de invitaciones.");
                if (!estaAutorizado) throw new Error("Acceso denegado: Un administrador debe registrar este correo en el sistema primero.");

                btn.innerHTML = 'Creando cuenta...';
                const { data, error } = await miSupabase.auth.signUp({
                    email, password,
                    options: { emailRedirectTo: window.location.href }
                });
                if (error) throw error;

                alert("‚úÖ ¬°Cuenta creada con √©xito! Revisa tu bandeja de entrada/spam y confirma tu correo.");
                e.target.reset();
                cerrarRegistro();
                document.getElementById('emailLogin').value = email;
                document.getElementById('passLogin').focus();
            } catch (err) {
                console.error("Error en registro:", err);
                alert("‚ùå " + err.message);
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        });

        // TABLA DE CLIENTES
        function renderizarTablaClientes(arreglo) {
            const tabla = document.getElementById('tablaCuerpo');
            if (arreglo.length === 0) {
                tabla.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-6 py-12 text-center text-gray-300 text-sm italic">
                            No se encontraron clientes que coincidan...
                        </td>
                    </tr>`;
                return;
            }
            tabla.innerHTML = arreglo.map(c => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-semibold text-sm text-gray-900">${c.nombre_completo}</td>
                    <td class="px-6 py-4 text-sm text-gray-400">
                        <div class="flex flex-col gap-0.5">
                            <span>üìû ${c.telefono}</span>
                            <span class="text-indigo-400">‚úâÔ∏è ${c.email}</span>
                        </div>
                    </td>

                    <td class="px-6 py-4 text-right">
                        <button onclick="mostrarPaseQR('${c.id}', '${c.nombre_completo}', '${c.telefono}', '${c.foto_url || ''}')"
                            class="bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-emerald-100 transition">
                            üì± QR
                        </button>
                    </td>
                </tr>`).join('');
        }

        function filtrarClientes() {
            const texto = document.getElementById('inputBuscarCliente').value.toLowerCase();
            const filtrados = listaClientesOriginal.filter(c =>
                c.nombre_completo.toLowerCase().includes(texto) ||
                c.email.toLowerCase().includes(texto)
            );
            renderizarTablaClientes(filtrados);
        }

        // REGISTRO NUEVO SUSCRIPTOR
        document.getElementById('formSuscriptor').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (totalClientesActual >= limiteClientesActual) {
                prepararYAbrirModalUpgrade(); return;
            }

            // --- NUEVA VALIDACI√ìN: TAMA√ëO DE LA FOTO (M√ÅXIMO 1 MB) ---
            const inputFoto = document.getElementById('fotoInput');
            if (inputFoto && inputFoto.files[0]) {
                const tama√±oBytes = inputFoto.files[0].size;
                if (tama√±oBytes > 1048576) { // 1048576 bytes = 1 MB
                    alert("‚ö†Ô∏è La foto del cliente es demasiado grande. Por favor, aseg√∫rate de que pese menos de 1 MB.");
                    inputFoto.value = ''; // Limpiamos el input para que pueda elegir otra sin recargar
                    return; // Detenemos la ejecuci√≥n aqu√≠ mismo
                }
            }
            // ---------------------------------------------------------

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Guardando...'; btn.disabled = true;

            try {
                let fotoUrl = null;
                const inputFoto = document.getElementById('fotoInput');
                
                if (inputFoto && inputFoto.files[0]) {
                    const fotoFile = inputFoto.files[0];
                    const fileName = `${miTenantId}/${Date.now()}_socio.png`;
                    const { data } = await miSupabase.storage.from('avatars').upload(fileName, fotoFile);
                    if (data) fotoUrl = miSupabase.storage.from('avatars').getPublicUrl(fileName).data.publicUrl;
                }

                const sel = document.getElementById('planElegido');
                const nuevoCliente = {
                    tenant_id: miTenantId,
                    nombre_completo: document.getElementById('nombre').value,
                    telefono: document.getElementById('telefono').value,
                    email: document.getElementById('email').value,
                    plan_id: sel.value,
                    meses_duracion: sel.options[sel.selectedIndex].getAttribute('data-meses'),
                    foto_url: fotoUrl,
                    contacto_emergencia: document.getElementById('contactoEmergencia').value
                };

                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${tokenActual}` },
                    body: JSON.stringify(nuevoCliente)
                });
                if (!res.ok) throw new Error("Error al guardar el cliente en el servidor.");

                // --- NUEVO: LLENAMOS Y MOSTRAMOS EL MODAL DE √âXITO ---
                const nombrePlanTexto = sel.options[sel.selectedIndex].text;
                document.getElementById('resNombre').innerText = nuevoCliente.nombre_completo;
                document.getElementById('resTelefono').innerText = nuevoCliente.telefono;
                document.getElementById('resEmail').innerText = nuevoCliente.email;
                document.getElementById('resEmergencia').innerText = nuevoCliente.contacto_emergencia || 'No registrado';
                document.getElementById('resPlan').innerText = nombrePlanTexto;
                
                document.getElementById('modalExitoCliente').classList.remove('hidden');

                e.target.reset();
                if(document.getElementById('fotoInput')) document.getElementById('fotoInput').value = '';
                await cargarDatosYDashboard();
            } catch (err) {
                console.error("Error al registrar suscriptor:", err);
                alert("‚ùå Error: " + err.message);
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        });

        // MODAL UPGRADE
        function prepararYAbrirModalUpgrade() {
            const titulo = document.getElementById('tituloPlanUpsell');
            const lista = document.getElementById('listaFeaturesUpsell');
            const btn = document.getElementById('btnPagarUpgrade');

            if (planSaasActual.toLowerCase() === 'starter') {
                titulo.innerText = 'Plan Pro ‚Äî $69/mes';
                lista.innerHTML = `
                    <li class="flex items-center gap-2">‚úÖ <span class="font-semibold">Hasta 500 clientes activos</span></li>
                    <li class="flex items-center gap-2">‚úÖ Usuarios de Staff ilimitados</li>
                    <li class="flex items-center gap-2">‚úÖ Recordatorios autom√°ticos por WhatsApp</li>`;
                btn.innerHTML = 'Mejorar a Plan Pro <span>üí≥</span>';
            } else if (planSaasActual.toLowerCase() === 'pro') {
                titulo.innerText = 'Plan Elite ‚Äî $149/mes';
                lista.innerHTML = `
                    <li class="flex items-center gap-2">‚úÖ <span class="font-semibold">Clientes y Staff Ilimitados</span></li>
                    <li class="flex items-center gap-2">‚úÖ Reportes avanzados de retenci√≥n</li>
                    <li class="flex items-center gap-2">‚úÖ Soporte Prioritario 24/7</li>`;
                btn.innerHTML = 'Mejorar a Plan Elite <span>üí≥</span>';
            } else {
                titulo.innerText = 'Ampliaci√≥n de Capacidad';
                lista.innerHTML = `<li class="flex items-center gap-2">‚úÖ <span class="font-semibold">Aumenta tu l√≠mite actual de servidor</span></li>`;
                btn.innerHTML = 'Contactar a Soporte <span>üéß</span>';
            }
            document.getElementById('modalUpgrade').classList.remove('hidden');
        }

        // --- SISTEMA DE NAVEGACI√ìN COMPLETO (ACTUALIZADO) ---
        function cambiarVista(vistaDestino) {
            // 1. Mapear pantallas
            const vistas = {
                'resumen': document.getElementById('vistaResumen'),
                'finanzas': document.getElementById('vistaFinanzas'),
                'staff': document.getElementById('vistaStaff'),
                'escanear': document.getElementById('vistaEscanear')
            };

            // 2. Apagar todas las pantallas
            Object.values(vistas).forEach(pantalla => {
                if (pantalla) pantalla.classList.add('hidden');
            });

            // 3. Encender la pantalla solicitada
            if (vistas[vistaDestino]) vistas[vistaDestino].classList.remove('hidden');

            // --- NUEVO: ACTUALIZAR ESTADO DEL MEN√ö LATERAL ---
            // A) Apagamos todos los botones (quitamos 'active', ponemos texto opaco)
            document.querySelectorAll('.nav-link').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-white/70');
            });

            // B) Encendemos solo el bot√≥n correcto
            const mapaBotones = {
                'resumen': 'btnNavDashboard',
                'staff': 'btnNavStaff',
                'finanzas': 'btnMenuFinanzas'
            };
            
            const btnActivo = document.getElementById(mapaBotones[vistaDestino]);
            if (btnActivo) {
                btnActivo.classList.add('active');
                btnActivo.classList.remove('text-white/70');
            } else if (vistaDestino === 'escanear') {
                // En caso de que el bot√≥n de escanear no tenga ID
                const btnEsc = document.querySelector('a[onclick="cambiarVista(\'escanear\')"]');
                if (btnEsc) {
                    btnEsc.classList.add('active');
                    btnEsc.classList.remove('text-white/70');
                }
            }

            // 4. Ejecutar l√≥gicas adicionales
            if (vistaDestino === 'finanzas') cargarDashboardFinanciero();
            else if (vistaDestino === 'staff') cargarStaff();
        }

        // Variables globales para evitar duplicar gr√°ficos al hacer clics m√∫ltiples
        let chartFlujo = null;
        let chartPlanes = null;

        // --- L√ìGICA DEL DASHBOARD FINANCIERO ---
        async function cargarDashboardFinanciero() {
            const paywall = document.getElementById('paywallFinanzas');
            
            // 1. GATEKEEPER SAAS
            if (planSaasActual.toLowerCase() !== 'elite') {
                paywall.classList.remove('hidden');
                return; 
            } else {
                paywall.classList.add('hidden');
            }

            try {
                // 2. EXTRAER DATOS REALES DE SUPABASE (¬°Nombres de columnas corregidos!)
                const { data: historial, error } = await miSupabase
                    .from('historial_suscripciones')
                    .select(`
                        estado_pago,
                        fecha_fin,
                        planes ( nombre_plan, precio, dias_duracion )
                    `)
                    .eq('tenant_id', miTenantId);

                if (error) throw error;

                // 3. VARIABLES PARA MATEM√ÅTICAS
                let mrr = 0;
                let activos = 0;
                let atrasados = 0;
                
                let ingresosPorPlan = {}; 
                let cashFlow15Dias = Array(15).fill(0); 
                
                const hoy = new Date();
                const limite15Dias = new Date();
                limite15Dias.setDate(hoy.getDate() + 15);

                // 4. PROCESAMIENTO DE DATOS
                historial.forEach(sub => {
                    // Adaptamos las variables a tu esquema real
                    const precio = sub.planes?.precio || 0;
                    const dias = sub.planes?.dias_duracion || 30;
                    const nombrePlan = sub.planes?.nombre_plan || 'Plan Gen√©rico';
                    
                    // Convertimos los d√≠as a meses para sacar el MRR (ej. 30 d√≠as = 1 mes, 90 d√≠as = 3 meses)
                    const meses = Math.max(1, Math.round(dias / 30));
                    const ingresoMensualReal = precio / meses;

                    if (sub.estado_pago === 'Pagado') {
                        activos++;
                        mrr += ingresoMensualReal;

                        if (!ingresosPorPlan[nombrePlan]) ingresosPorPlan[nombrePlan] = 0;
                        ingresosPorPlan[nombrePlan] += ingresoMensualReal;
                    } else if (sub.estado_pago === 'Atrasado') {
                        atrasados++;
                    }

                    // C√°lculo de Flujo de Caja
                    if (sub.fecha_fin) {
                        const fechaVence = new Date(sub.fecha_fin);
                        // Si vence hoy o en los pr√≥ximos 15 d√≠as, no cuenta los que vencieron en el pasado
                        if (fechaVence >= hoy && fechaVence <= limite15Dias) {
                            const diffTime = Math.abs(fechaVence - hoy);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            if (diffDays >= 0 && diffDays < 15) {
                                cashFlow15Dias[diffDays] += precio; 
                            }
                        }
                    }
                });

                // 5. C√ÅLCULO DE CHURN Y RETENCI√ìN
                const totalHistorico = activos + atrasados;
                let churn = 0;
                let retencion = 100;
                if (totalHistorico > 0) {
                    churn = Math.round((atrasados / totalHistorico) * 100);
                    retencion = 100 - churn;
                }

                // 6. ACTUALIZAR HTML (KPIs)
                document.getElementById('kpiMRR').innerText = mrr.toFixed(2);
                document.getElementById('kpiRetencion').innerText = retencion;
                document.getElementById('kpiChurn').innerText = churn;

                // 7. PREPARAR DATOS PARA GR√ÅFICOS
                // Generamos fechas reales en lugar de "D√≠a 1, D√≠a 2"
                const etiquetasDias = Array.from({length: 15}, (_, i) => {
                    if (i === 0) return 'Hoy';
                    if (i === 1) return 'Ma√±ana';
                    let d = new Date();
                    d.setDate(d.getDate() + i);
                    return d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }); 
                });
                
                const etiquetasPlanes = Object.keys(ingresosPorPlan);
                const datosPlanes = Object.values(ingresosPorPlan);

                // 8. RENDERIZAR GR√ÅFICO DE FLUJO DE CAJA
                const ctxFlujo = document.getElementById('graficoFlujoCaja').getContext('2d');
                if (chartFlujo) chartFlujo.destroy();
                
                chartFlujo = new Chart(ctxFlujo, {
                    type: 'bar',
                    data: {
                        labels: etiquetasDias,
                        datasets: [{
                            label: 'Renovaciones Proyectadas ($)',
                            data: cashFlow15Dias,
                            backgroundColor: '#10B981',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // 9. RENDERIZAR GR√ÅFICO DE ANILLO
                const ctxPlanes = document.getElementById('graficoPlanes').getContext('2d');
                if (chartPlanes) chartPlanes.destroy();
                
                const colores = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];

                chartPlanes = new Chart(ctxPlanes, {
                    type: 'doughnut',
                    data: {
                        labels: etiquetasPlanes.length > 0 ? etiquetasPlanes : ['Sin datos'],
                        datasets: [{
                            data: datosPlanes.length > 0 ? datosPlanes : [1],
                            backgroundColor: colores.slice(0, etiquetasPlanes.length || 1),
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        cutout: '70%'
                    }
                });

            } catch (error) {
                console.error("Error al cargar datos financieros:", error);
            }
        }
    </script>
</body>
</html>