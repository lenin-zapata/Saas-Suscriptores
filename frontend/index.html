<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS MemberLy - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }

        /* Sidebar nav active / hover */
        .nav-link { transition: all 0.2s ease; }
        .nav-link.active  { background: rgba(255,255,255,0.15); color:#fff; }
        .nav-link:hover:not(.active) { background: rgba(255,255,255,0.08); }

        /* Subtle animated gradient on login */
        .login-bg {
            background: linear-gradient(135deg, #065f46 0%, #047857 40%, #059669 70%, #10b981 100%);
            background-size: 300% 300%;
            animation: gradientShift 8s ease infinite;
        }
        @keyframes gradientShift {
            0%   { background-position: 0% 50%; }
            50%  { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* KPI card hover lift */
        .kpi-card { transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }

        /* Table row transitions */
        tbody tr { transition: background 0.15s; }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1fae5; border-radius: 99px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">

    <div id="pantallaLogin" class="w-full h-full flex items-center justify-center login-bg fixed z-50">

        <div class="absolute top-0 left-0 w-72 h-72 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
        <div class="absolute bottom-0 right-0 w-96 h-96 bg-white/5 rounded-full translate-x-1/3 translate-y-1/3 pointer-events-none"></div>

        <div class="relative bg-white rounded-3xl shadow-2xl w-[420px] max-w-[calc(100vw-2rem)] overflow-hidden">
            <div class="bg-emerald-600 px-10 pt-10 pb-8 text-center">
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
                <h1 class="text-2xl font-extrabold text-white tracking-tight">JS MemberLy</h1>
                <p class="text-emerald-100 text-sm mt-1">Panel de Administraci√≥n</p>
            </div>

            <form id="formLogin" class="px-10 py-8 flex flex-col gap-5">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Correo Electr√≥nico</label>
                    <input type="email" id="emailLogin" required
                        class="w-full border border-gray-200 bg-gray-50 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 outline-none transition text-sm"
                        placeholder="admin@irongym.com">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Contrase√±a</label>
                    <input type="password" id="passLogin" required
                        class="w-full border border-gray-200 bg-gray-50 px-4 py-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 outline-none transition text-sm"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button type="submit"
                    class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-200 mt-1 text-sm">
                    Ingresar al Sistema
                </button>

                <div class="text-center">
                    <button type="button" onclick="solicitarResetPassword()"
                        class="text-xs text-emerald-600 hover:text-emerald-800 font-semibold transition underline underline-offset-4">
                        ¬øOlvidaste tu contrase√±a?
                    </button>
                </div>

                <div class="border-t border-gray-100 pt-5 text-center">
                    <p class="text-xs text-gray-400 mb-2">¬øEres personal nuevo?</p>
                    <button type="button" onclick="abrirRegistro()"
                        class="text-sm text-emerald-600 hover:text-emerald-800 font-bold transition">
                        Crear mi cuenta de acceso
                    </button>
                </div>

                <p id="errorLogin" class="text-red-500 text-xs text-center hidden font-medium bg-red-50 py-2 px-3 rounded-lg"></p>
            </form>
        </div>
    </div>

    <div id="pantallaDashboard" class="flex w-full h-full hidden">

        <aside class="w-64 bg-emerald-900 text-white flex flex-col shadow-2xl z-10 shrink-0">

            <div class="p-6 flex flex-col items-center border-b border-white/10 text-center">
                <div class="relative group cursor-pointer w-20 h-20 rounded-2xl bg-white/10 flex items-center justify-center overflow-hidden mb-3 border border-white/20 shadow-inner">
                    <img id="logoGymImg" src="https://via.placeholder.com/150?text=Logo" alt="Logo Gym" class="w-full h-full object-cover">
                    <label for="uploadLogo" class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer text-[10px] text-white gap-1">
                        <span class="text-lg">üì∑</span><span>Cambiar</span>
                    </label>
                    <input type="file" id="uploadLogo" class="hidden" accept="image/*" onchange="subirLogo(this)">
                </div>
                <h2 id="nombreGymSidebar" class="text-sm font-bold tracking-wide text-white">Cargando...</h2>
            </div>

            <nav class="flex-1 p-4 flex flex-col gap-1">
                <a href="#" onclick="cambiarVista('resumen')" id="btnNavDashboard"
                    class="nav-link active flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold">
                    <span class="text-base">üìä</span> Dashboard
                </a>
                <a href="#" onclick="cambiarVista('staff')" id="btnNavStaff"
                    class="solo-admin nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-white/70">
                    <span class="text-base">üë•</span> Gestionar Staff
                </a>
                <a href="#" onclick="cambiarVista('finanzas')" id="btnMenuFinanzas" class="solo-admin nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-white/70">
                    <span>üìä</span> <span class="font-medium">Finanzas</span>
                    <span class="ml-auto text-[10px] bg-yellow-400 text-yellow-900 font-bold px-2 py-0.5 rounded-full uppercase">Elite</span>
                </a>
                <a onclick="cambiarVista('escanear')"
                    class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-white/70 cursor-pointer">
                    <span class="text-base">üì∑</span> Escanear Pase
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <button onclick="cerrarSesion()"
                    class="w-full flex items-center justify-center gap-2 text-white/50 hover:text-white px-4 py-2 rounded-xl text-sm transition font-medium">
                    <span>üö™</span> Cerrar Sesi√≥n
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-y-auto bg-gray-50">

            <header class="bg-white border-b border-gray-100 px-8 py-4 flex justify-between items-center sticky top-0 z-40">
                <div>
                    <h1 class="text-xl font-extrabold text-gray-900 tracking-tight">Resumen General</h1>
                    <p class="text-xs text-gray-400 font-medium mt-0.5">Panel de control de tu gimnasio</p>
                </div>
                <div class="relative group">
                    <button class="flex items-center gap-3 hover:bg-gray-50 p-2 rounded-2xl transition">
                        <div id="userInitialsCircle"
                            class="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center text-emerald-700 font-extrabold border-2 border-white shadow-sm text-sm">A</div>
                        <div class="text-left hidden md:block">
                            <p id="userNameDisplay" class="text-sm font-bold text-gray-800 leading-none">Usuario</p>
                            <p class="text-[10px] text-gray-400 font-semibold uppercase mt-1">Mi Cuenta ‚ñº</p>
                        </div>
                    </button>
                    <div class="absolute right-0 w-48 mt-1 bg-white rounded-2xl shadow-xl border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                        <div class="p-2">
                            <button onclick="document.getElementById('modalPassword').classList.remove('hidden')"
                                class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-600 hover:bg-emerald-50 hover:text-emerald-700 rounded-xl transition">üîê Nueva Clave</button>
                            <div class="border-t border-gray-100 my-1"></div>
                            <button onclick="abrirModalPlanes()" class="solo-admin w-full flex items-center gap-3 px-4 py-2.5 text-sm text-gray-600 hover:bg-emerald-50 hover:text-emerald-700 rounded-xl transition">
                                ‚öôÔ∏è Ajustar Precios
                            </button>
                            <button onclick="cerrarSesion()"
                                class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-500 hover:bg-red-50 rounded-xl font-semibold transition">üö™ Salir</button>
                        </div>
                    </div>
                </div>
            </header>

            <div id="vistaResumen" class="p-8 space-y-6">

                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">

                    <div class="solo-admin kpi-card bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex flex-col gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-2xl bg-emerald-50 flex items-center justify-center text-2xl shrink-0">üë•</div>
                            <div>
                                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Clientes Activos</p>
                                <h3 class="text-3xl font-extrabold text-gray-900 leading-none mt-1">
                                    <span id="kpiTotal">0</span>
                                    <span class="text-base text-gray-300 font-semibold"> / <span id="kpiLimite">100</span></span>
                                </h3>
                            </div>
                        </div>
                        <div>
                            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                <div id="barraUsoPlan" class="bg-emerald-500 h-2 rounded-full transition-all duration-700" style="width:0%"></div>
                            </div>
                            <div class="flex justify-between items-center mt-2.5">
                                <p class="text-[11px] text-gray-400 font-semibold">Plan <span id="nombrePlanSaas" class="capitalize font-extrabold text-emerald-600">Starter</span></p>
                                <button onclick="prepararYAbrirModalUpgrade()"
                                    class="text-[11px] bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg font-bold hover:bg-emerald-100 transition flex items-center gap-1">
                                    üöÄ Subir de Nivel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="solo-admin kpi-card bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-emerald-50 flex items-center justify-center text-2xl shrink-0">‚úÖ</div>
                        <div>
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Al D√≠a</p>
                            <h3 id="kpiAlDia" class="text-3xl font-extrabold text-emerald-600 leading-none mt-1">0</h3>
                        </div>
                    </div>

                    <div class="solo-admin kpi-card bg-white rounded-3xl p-6 border border-gray-100 shadow-sm flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-red-50 flex items-center justify-center text-2xl shrink-0">‚ö†Ô∏è</div>
                        <div>
                            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Atrasados</p>
                            <h3 id="kpiMorosos" class="text-3xl font-extrabold text-red-500 leading-none mt-1">0</h3>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

                    <div class="lg:col-span-2 bg-white rounded-3xl border border-gray-100 shadow-sm p-6">
                        <h2 class="text-base font-extrabold text-gray-800 mb-5 flex items-center gap-2">
                            <span class="w-7 h-7 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm">‚ûï</span>
                            Registrar Nuevo Suscriptor
                        </h2>
                        <form id="formSuscriptor" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Nombre</label>
                                <input type="text" id="nombre" required placeholder="Nombre y Apellido"
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">WhatsApp</label>
                                <input type="text" id="telefono" required placeholder="+593..."
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Email</label>
                                <input type="email" id="email" required placeholder="test@example.com"
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Contacto de Emergencia</label>
                                <input type="text" id="contactoEmergencia" required placeholder="Tel√©fono de contacto"
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition">
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Plan</label>
                                <select id="planElegido" required
                                    class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none text-sm transition"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Foto del Cliente</label>
                                <input type="file" id="fotoInput" accept="image/*" required
                                    class="w-full border border-gray-200 bg-gray-50 p-1.5 rounded-xl text-sm file:mr-4 file:py-1.5 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200 transition cursor-pointer">
                            </div>
                            
                            <div class="mt-5 mb-6 flex items-center justify-between bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                <div>
                                    <label class="text-sm font-bold text-emerald-900 block">üîÑ Renovaci√≥n Autom√°tica</label>
                                    <p class="text-[11px] text-emerald-700 mt-0.5 leading-tight">Cobro autom√°tico 1 d√≠a despu√©s del vencimiento. Si se desactiva, se enviar√° link de pago 3 d√≠as antes.</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="renovacionAutoCliente" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                                </label>
                            </div>

                            <div class="md:col-span-2 mt-2">
                                <button type="submit"
                                    class="px-8 py-2.5 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 text-sm">
                                    Guardar Cliente
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="solo-admin bg-white rounded-3xl border border-gray-100 shadow-sm p-6 flex flex-col">
                        <h2 class="text-base font-extrabold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="w-7 h-7 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm">üìä</span>
                            Estado de Pagos
                        </h2>
                        <div class="flex-1 flex items-center justify-center min-h-[180px]">
                            <canvas id="graficoPagos"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="px-6 py-5 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 class="text-base font-extrabold text-gray-800 flex items-center gap-2">
                            <span class="w-7 h-7 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm">üìã</span>
                            Directorio de Clientes
                        </h2>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
    
                            <div class="relative w-full md:w-2/3 lg:w-3/4">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input type="text" id="inputBuscarCliente" onkeyup="filtrarClientes()" placeholder="Buscar por nombre, correo o tel√©fono..." 
                                    class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all placeholder-gray-400 font-medium">
                            </div>

                            <div class="flex items-center gap-3 shrink-0">
                                <label for="filtroEstado" class="text-xs font-extrabold text-gray-400 uppercase tracking-wider hidden lg:block">Estado:</label>
                                
                                <div class="relative min-w-[190px]">
                                    <select id="filtroEstado" onchange="filtrarClientes()" 
                                        class="w-full appearance-none bg-emerald-50 border border-emerald-100 text-emerald-800 py-3 pl-4 pr-10 rounded-xl text-sm font-bold cursor-pointer focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all hover:bg-emerald-100 truncate">
                                        <option value="Activos y Atrasados" selected>üü¢üü° Activos y Atrasados</option>
                                        <option value="Todos">üåü Todos los estados</option>
                                        <option value="Activo">üü¢ Activos</option>
                                        <option value="Atrasado">üü° Atrasados</option>
                                        <option value="Inactivo">üî¥ Inactivos</option>
                                        <option value="Sin plan">‚ö™ Sin plan</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-emerald-600">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50 border-b border-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-extrabold text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th class="px-6 py-4 text-left text-xs font-extrabold text-gray-500 uppercase tracking-wider">Contacto</th>
                                    <th class="px-6 py-4 text-left text-xs font-extrabold text-gray-500 uppercase tracking-wider">Emergencia</th>
                                    <th class="px-6 py-4 text-left text-xs font-extrabold text-gray-500 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-4 text-left text-xs font-extrabold text-gray-500 uppercase tracking-wider">Vence</th>
                                    <th class="px-6 py-4 text-left text-xs font-extrabold text-gray-500 uppercase tracking-wider">Registrado</th>
                                    <th class="px-6 py-4 text-right text-xs font-extrabold text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCuerpo" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>

            </div>
            
            <div id="vistaFinanzas" class="hidden px-8 pb-8 pt-2 relative min-h-[600px] max-w-5xl mx-auto w-full">

                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800 text-center md:text-left">Reportes Financieros Avanzados</h2>
                    
                    <button onclick="simularMotorCobros()" class="bg-indigo-600 text-white font-bold py-2.5 px-5 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-100 flex items-center gap-2 text-sm">
                        ü§ñ Ejecutar Motor de Cobros (Simulador)
                    </button>
                </div>

                <div id="paywallFinanzas" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-white/70 backdrop-blur-md rounded-2xl">
                    <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md border border-indigo-50 mx-4">
                        <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">üîí</div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Exclusivo del Plan Elite</h3>
                        <p class="text-gray-500 text-sm mb-6 leading-relaxed">Desbloquea proyecciones de flujo de caja, an√°lisis de retenci√≥n y m√©tricas de ingresos recurrentes para escalar tu negocio.</p>
                        <button onclick="prepararYAbrirModalUpgrade()" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl hover:bg-black transition shadow-md flex justify-center items-center gap-2">
                            Desbloquear Finanzas üöÄ
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pb-10 items-start">
                    
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center h-full">
                        <p class="text-sm text-gray-500 font-medium mb-2 uppercase tracking-wider">Ingreso Recurrente Mensual (MRR)</p>
                        <h3 class="text-5xl font-extrabold text-emerald-600 mb-3 tracking-tight">$<span id="kpiMRR">0.00</span></h3>
                        <span id="kpiCrecimiento" class="text-xs font-bold px-3 py-1.5 rounded-md text-emerald-600 bg-emerald-50 mt-1 inline-block transition-all">
                            Calculando...
                        </span>
                    </div>

                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-center items-center text-center h-full">
                        <p class="text-sm text-gray-500 font-medium mb-2 uppercase tracking-wider">Tasa de Retenci√≥n Anual</p>
                        <h3 class="text-5xl font-extrabold text-indigo-600 mb-3 tracking-tight"><span id="kpiRetencion">0</span>%</h3>
                        <p class="text-xs text-red-700 bg-red-50 px-3 py-1.5 rounded-full font-bold inline-flex items-center gap-1">
                            <span>üìâ</span> Tasa de abandono: <span id="kpiChurn">0</span>%
                        </p>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                        <h3 class="text-base font-bold text-gray-800 mb-6 text-center md:text-left">Proyecci√≥n de Flujo de Caja (15 d√≠as)</h3>
                        <div class="relative h-72 w-full">
                            <canvas id="graficoFlujoCaja"></canvas>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                        <h3 class="text-base font-bold text-gray-800 mb-6 text-center md:text-left">Distribuci√≥n de Ingresos</h3>
                        <div class="relative h-72 w-full flex justify-center">
                            <canvas id="graficoPlanes"></canvas>
                        </div>
                    </div>

                </div>
            </div>

            <div id="vistaStaff" class="hidden p-8 w-full max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-extrabold text-gray-900 tracking-tight">Gestionar Personal</h2>
                        <p class="text-xs text-gray-400 font-medium mt-1">Administra los accesos de tu equipo</p>
                    </div>
                    <button onclick="document.getElementById('modalNuevoStaff').classList.remove('hidden')"
                        class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-emerald-100 hover:bg-emerald-700 transition text-sm">
                        + Nuevo Miembro
                    </button>
                </div>
                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-100">
                                <th class="px-6 py-4 text-left text-[10px] font-bold text-gray-400 uppercase tracking-widest">Nombre</th>
                                <th class="px-6 py-4 text-left text-[10px] font-bold text-gray-400 uppercase tracking-widest">Rol</th>
                                <th class="px-6 py-4 text-right text-[10px] font-bold text-gray-400 uppercase tracking-widest">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaStaff" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>

            <div id="vistaEscanear" class="hidden p-8 w-full max-w-6xl mx-auto">
                <h2 class="text-2xl font-extrabold text-gray-900 tracking-tight mb-1">Escanear Pase</h2>
                <p class="text-xs text-gray-400 font-medium mb-8">Verifica el acceso de tus clientes con c√≥digo QR</p>
                
                <div class="bg-white p-10 rounded-3xl border border-gray-100 shadow-sm text-center max-w-lg mx-auto flex flex-col items-center">
                    <div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-4xl mb-6">üì∑</div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Lector de Accesos</h3>
                    <p class="text-sm text-gray-500 mb-8">Usa la c√°mara de tu dispositivo para leer el c√≥digo QR del pase del cliente.</p>
                    <button onclick="abrirEscanner()" class="w-full bg-emerald-600 text-white font-bold py-3.5 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100">
                        Activar C√°mara y Escanear
                    </button>
                </div>
            </div>

        </main>
    </div>

    <div id="modalPassword" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm border border-gray-100">
            <h2 class="text-lg font-extrabold mb-1 text-gray-900">üîí Actualizar Contrase√±a</h2>
            <p class="text-xs text-gray-400 mb-6">M√≠nimo 6 caracteres.</p>
            <form id="formUpdatePassword" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Nueva Clave</label>
                    <input type="password" id="newPassword" required minlength="6"
                        class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm">
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition text-sm">Guardar Cambios</button>
                <button type="button" onclick="cancelarReset()" class="text-gray-400 text-xs text-center hover:text-gray-600 transition">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="modalNuevoStaff" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border border-gray-100">
            <h2 class="text-lg font-extrabold mb-1 text-gray-900">‚ûï Agregar Personal</h2>
            <p class="text-xs text-gray-400 mb-6">Se enviar√° una invitaci√≥n por WhatsApp.</p>
            <form id="formNuevoStaff" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Nombre</label>
                    <input type="text" id="nombreStaff" required class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Email</label>
                    <input type="email" id="emailStaff" required class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Tel√©fono (WhatsApp)</label>
                    <input type="text" id="telefonoStaff" required class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm" placeholder="+593...">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Rol</label>
                    <select id="rolStaff" class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm">
                        <option value="recepcionista">Recepcionista</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="flex gap-3 mt-2">
                    <button type="submit" class="flex-1 bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-100 transition text-sm">Registrar</button>
                    <button type="button" onclick="document.getElementById('modalNuevoStaff').classList.add('hidden')"
                        class="px-5 text-gray-400 font-semibold text-sm hover:text-gray-600 transition">Cerrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalQR" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden max-w-sm w-full mx-4 border border-gray-100">
            <div class="bg-emerald-700 p-6 text-center relative">
                <button onclick="document.getElementById('modalQR').classList.add('hidden')"
                    class="absolute top-4 right-4 text-emerald-200 hover:text-white text-lg transition">‚úï</button>
                
                <img id="fotoClienteQR" src="" alt="Foto Cliente" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover border-4 border-emerald-500 shadow-md bg-white">
                
                <h2 class="text-lg font-extrabold text-white">Pase de Acceso</h2>
                <p id="nombreClienteQR" class="text-emerald-200 text-sm mt-1"></p>
            </div>
            <div class="p-8 flex flex-col items-center gap-6">
                <div id="contenedorQR" class="p-4 bg-white border border-gray-100 rounded-2xl shadow-inner"></div>
                <button id="btnEnviarWA"
                    class="w-full bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-3.5 rounded-2xl shadow-lg transition text-sm">
                    üì≤ Enviar por WhatsApp
                </button>
            </div>
        </div>
    </div>

    <div id="modalExitoCliente" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border border-emerald-100 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-emerald-500"></div>
            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-4xl mx-auto mb-4 shadow-inner">üéâ</div>
            <h2 class="text-2xl font-extrabold text-gray-900 mb-2">¬°Cliente Registrado!</h2>
            <p class="text-gray-500 text-sm mb-6">El suscriptor ha sido guardado exitosamente.</p>
            
            <div class="bg-gray-50 rounded-2xl p-5 mb-6 text-left border border-gray-100 space-y-3">
                <p class="text-sm"><span class="font-bold text-gray-700">Nombre:</span> <span id="resNombre" class="text-gray-600"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-700">WhatsApp:</span> <span id="resTelefono" class="text-gray-600"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-700">Email:</span> <span id="resEmail" class="text-gray-600"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-700">Emergencia:</span> <span id="resEmergencia" class="text-gray-600"></span></p>
                <p class="text-sm"><span class="font-bold text-gray-700">Plan:</span> <span id="resPlan" class="text-gray-600 font-bold text-emerald-600"></span></p>
            </div>

            <button onclick="document.getElementById('modalExitoCliente').classList.add('hidden')" class="w-full bg-emerald-600 text-white font-bold py-3.5 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 text-sm">
                Genial, continuar üëç
            </button>
        </div>
    </div>

    <div id="lectorQRContainer" class="fixed inset-0 bg-black/80 hidden z-[70] flex items-center justify-center">
        <div class="bg-white p-6 rounded-3xl w-full max-w-md text-center border border-gray-100">
            <div id="reader"></div>
            <button onclick="cerrarEscanner()"
                class="w-full mt-4 p-2.5 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-sm transition">Cancelar</button>
        </div>
    </div>

    <div id="modalRegistro" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm border border-gray-100">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center text-xl mx-auto mb-3">üìù</div>
                <h2 class="text-lg font-extrabold text-gray-900">Activar Cuenta</h2>
                <p class="text-xs text-gray-400 mt-1">Usa el correo exacto con el que el administrador te registr√≥.</p>
            </div>
            <form id="formRegistro" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Correo Electr√≥nico</label>
                    <input type="email" id="emailRegistro" required
                        class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm" placeholder="tu_correo@gym.com">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">CONFIRMA TU CORREO</label>
                    <input type="email" id="emailRegistroConfirm" required class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm" placeholder="Repite tu correo">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">Crea una Contrase√±a</label>
                    <input type="password" id="passRegistro" required minlength="6"
                        class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm" placeholder="M√≠nimo 6 caracteres">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1.5">CONFIRMA TU CONTRASE√ëA</label>
                    <input type="password" id="passRegistroConfirm" required minlength="6" class="w-full border border-gray-200 bg-gray-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm" placeholder="Repite tu contrase√±a">
                </div>

                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 mt-2 text-sm">
                    Crear Cuenta
                </button>
                <button type="button" onclick="cerrarRegistro()" class="text-gray-400 text-xs text-center hover:text-gray-600 transition">
                    Cancelar y volver al Login
                </button>
            </form>
        </div>
    </div>

    <div id="modalUpgrade" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-[110] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg text-center border border-emerald-100">
            <div class="w-20 h-20 bg-emerald-50 rounded-3xl flex items-center justify-center mx-auto mb-4 border-4 border-emerald-100 text-4xl">üöÄ</div>
            <h2 class="text-2xl font-extrabold mb-2 text-gray-900">¬°Tu gimnasio est√° creciendo!</h2>
            <p class="text-gray-500 text-sm mb-6 leading-relaxed">
                Est√°s alcanzando el l√≠mite de clientes de tu plan actual.<br>
                Es momento de subir de nivel y desbloquear m√°s herramientas.
            </p>
            <div class="bg-gray-50 rounded-2xl p-6 mb-6 text-left border border-gray-100">
                <h3 id="tituloPlanUpsell" class="font-extrabold text-gray-900 mb-3 text-base">Cargando plan...</h3>
                <ul id="listaFeaturesUpsell" class="text-sm text-gray-600 space-y-2"></ul>
            </div>
            <div class="flex gap-3">
                <button id="btnPagarUpgrade" onclick="iniciarPagoUpgrade()"
                    class="flex-1 bg-emerald-600 text-white font-bold py-3.5 rounded-2xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 flex justify-center items-center gap-2 text-sm">
                    Mejorar Plan <span>üí≥</span>
                </button>
                <button onclick="document.getElementById('modalUpgrade').classList.add('hidden')"
                    class="px-6 text-gray-400 font-semibold hover:text-gray-600 transition text-sm">
                    Quiz√°s luego
                </button>
            </div>
        </div>
    </div>

    <div id="modalAjustarPlanes" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[110] backdrop-blur-sm pt-10 pb-10">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border border-gray-100 my-auto max-h-[90vh] overflow-y-auto">
            
            <h2 class="text-xl font-extrabold mb-1 text-gray-900">‚öôÔ∏è Gesti√≥n de Membres√≠as</h2>
            <p class="text-xs text-gray-400 mb-6">Ajusta los precios actuales o crea nuevos planes para tu gimnasio.</p>
            
            <form id="formAjustarPlanes" class="flex flex-col gap-3">
                <div id="contenedorPlanesDinamicos" class="space-y-3 max-h-56 overflow-y-auto p-3 bg-gray-50 rounded-2xl border border-gray-100 shadow-inner">
                    <p class="text-sm text-gray-500 text-center italic">Cargando tus planes...</p>
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 text-sm mt-1">
                    üíæ Guardar Precios
                </button>
            </form>

            <div class="relative my-7">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-3 bg-white text-gray-400 font-extrabold text-[10px] tracking-widest uppercase">O crear nuevo</span>
                </div>
            </div>

            <form id="formNuevoPlan" class="flex flex-col gap-3 bg-emerald-50 p-5 rounded-2xl border border-emerald-100">
                <div>
                    <input type="text" id="nuevoPlanNombre" required placeholder="Nombre (ej. Plan VIP)" class="w-full border border-white bg-white p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm shadow-sm transition">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 font-bold">$</span>
                        <input type="number" step="0.01" id="nuevoPlanPrecio" required placeholder="Precio" class="w-full border border-white bg-white pl-8 pr-3 py-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm shadow-sm transition">
                    </div>
                    <div>
                        <input type="number" id="nuevoPlanDias" required placeholder="D√≠as (ej. 30)" class="w-full border border-white bg-white p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-400 text-sm shadow-sm transition">
                    </div>
                </div>
                <button type="submit" class="w-full bg-gray-900 text-white font-bold py-3 rounded-xl hover:bg-black transition text-sm flex justify-center items-center gap-2 mt-1 shadow-md">
                    ‚ûï A√±adir Plan
                </button>
            </form>

            <button type="button" onclick="document.getElementById('modalAjustarPlanes').classList.add('hidden')" class="w-full mt-5 text-gray-400 font-semibold hover:text-gray-600 transition text-sm">
                Cerrar Ventana
            </button>
        </div>
    </div>

    <div id="modalRenovarPlan" class="hidden fixed inset-0 z-[100] flex justify-center items-center bg-gray-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up border border-emerald-100">
            <div class="bg-emerald-600 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg flex items-center gap-2"><span>üîÑ</span> Renovar o Cambiar Plan</h3>
                <button type="button" onclick="cerrarModalRenovar()" class="text-emerald-100 hover:text-white transition text-3xl leading-none">&times;</button>
            </div>
            <form id="formRenovarPlan" class="p-6">
                <input type="hidden" id="renovarClienteId">
                <p class="text-sm text-gray-500 mb-5">Socio seleccionado: <br><span id="renovarClienteNombre" class="font-extrabold text-gray-800 text-lg"></span></p>

                <div class="mb-5">
                    <label class="block text-xs font-extrabold text-gray-400 uppercase tracking-wider mb-2">Seleccionar Nuevo Plan</label>
                    <select id="renovarPlanElegido" required class="w-full border border-gray-200 bg-gray-50 px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 text-sm font-bold text-emerald-800 transition cursor-pointer">
                        <option value="">Cargando planes...</option>
                    </select>
                </div>

                <div class="mb-8 flex items-center justify-between bg-emerald-50/50 p-4 rounded-xl border border-emerald-100">
                    <div>
                        <label class="text-sm font-bold text-emerald-900 block">Renovaci√≥n Autom√°tica</label>
                        <p class="text-[11px] text-emerald-600 mt-1 leading-tight">Activar cobros autom√°ticos al finalizar el plan.</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="renovarAutoSwitch" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                    </label>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="cerrarModalRenovar()" class="w-1/2 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition">Cancelar</button>
                    <button type="submit" class="w-1/2 bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">Guardar Renovaci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kfqdefzuwejwmupgvelg.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcWRlZnp1d2Vqd211cGd2ZWxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MTcwMzYsImV4cCI6MjA4Njk5MzAzNn0.Wdr14R9gZ6Osy8RrVaYXC6CKUtBoYqbE9tV3oiekCPE';
        const API_URL = "http://localhost:8787/suscriptores";
        const API_PLANES = "http://localhost:8787/planes";
        
        const miSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let tokenActual = null;
        let miTenantId = null; 
        let graficoInstancia = null;
        let modoRecuperacion = false;
        let listaClientesOriginal = [];

        let limiteClientesActual = 100;
        let planSaasActual = 'starter';
        let totalClientesActual = 0;

        // LOGIN
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const errorMsg = document.getElementById('errorLogin');
            btn.innerHTML = 'Cargando...'; btn.disabled = true; errorMsg.classList.add('hidden');

            try {
                const email = document.getElementById('emailLogin').value;
                const password = document.getElementById('passLogin').value;

                const { data, error: authError } = await miSupabase.auth.signInWithPassword({ email, password });
                if (authError) throw authError;

                tokenActual = data.session.access_token;
                const userEmail = data.session.user.email;
                const userId = data.session.user.id;

                let { data: staffData } = await miSupabase
                    .from('perfiles_staff')
                    .select('*')
                    .or(`id.eq.${userId},email.eq.${userEmail}`);

                if (staffData && staffData.length > 0) {
                    const perfil = staffData[0];
                    miTenantId = perfil.tenant_id;
                    
                    if (perfil.id !== userId) {
                        await miSupabase.from('perfiles_staff').update({ id: userId }).eq('email', userEmail);
                    }

                    document.getElementById('userNameDisplay').innerText = perfil.nombre;
                    document.getElementById('userInitialsCircle').innerText = perfil.nombre.charAt(0).toUpperCase();
                    aplicarPermisos(perfil.rol);

                    const { data: negocio } = await miSupabase.from('tenants').select('*').eq('id', miTenantId).single();
                    if (negocio) {
                        document.getElementById('nombreGymSidebar').innerText = negocio.nombre_negocio;
                        if (negocio.logo_url) document.getElementById('logoGymImg').src = negocio.logo_url;
                        planSaasActual = negocio.plan_saas || 'starter';
                        limiteClientesActual = negocio.limite_clientes || 100;
                        if (negocio.estado_suscripcion !== 'activa') {
                            alert("‚ö†Ô∏è La suscripci√≥n de tu gimnasio est√° inactiva. Funcionalidades limitadas.");
                        }
                    }

                    document.getElementById('pantallaLogin').classList.add('hidden');
                    document.getElementById('pantallaDashboard').classList.remove('hidden');
                    await cargarPlanes();
                    await cargarDatosYDashboard();
                } else {
                    throw new Error("No tienes un perfil asignado en este sistema.");
                }
            } catch (err) {
                console.error(err);
                errorMsg.innerText = "Error: " + err.message;
                errorMsg.classList.remove('hidden');
            } finally {
                btn.innerHTML = 'Ingresar al Sistema'; btn.disabled = false;
            }
        });

        // NAVEGACI√ìN Y CARGA DE STAFF
        async function cargarStaff() {
            if (!miTenantId) return;
            const { data: staff } = await miSupabase.from('perfiles_staff').select('*').eq('tenant_id', miTenantId).order('nombre');
            if (staff) {
                document.getElementById('tablaStaff').innerHTML = staff.map(s => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 font-semibold text-sm text-gray-800">
                            ${s.nombre}
                            <br><span class="text-[10px] text-gray-400 font-normal">${s.email || 'Pendiente'}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2.5 py-1 rounded-lg text-[10px] font-bold ${s.rol === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-emerald-100 text-emerald-700'}">
                                ${s.rol.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            ${s.rol !== 'admin'
                                ? `<button onclick="eliminarStaff('${s.id}')" class="text-red-500 hover:text-red-700 text-sm font-bold transition">Eliminar</button>`
                                : `<span class="text-gray-300 text-xs italic">Protegido</span>`}
                        </td>
                    </tr>
                `).join('');
            }
        }

        document.getElementById('formNuevoStaff').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Guardando...'; btn.disabled = true;

            const nombre = document.getElementById('nombreStaff').value;
            const email = document.getElementById('emailStaff').value;
            const telefono = document.getElementById('telefonoStaff').value;
            const rol = document.getElementById('rolStaff').value;

            try {
                const { error: dbError } = await miSupabase
                    .from('perfiles_staff')
                    .insert([{ tenant_id: miTenantId, nombre, email, telefono, rol }]);
                if (dbError) throw dbError;

                // 1. Extraemos el nombre del gimnasio que ya est√° cargado en la barra lateral
                const nombreGym = document.getElementById('nombreGymSidebar').innerText;
                const urlRegistro = window.location.href.split('#')[0]; 
                const mensaje = `Hola ${nombre}, te he agregado al equipo de ${nombreGym} en JS MemberLy. \n\nPor favor, ingresa a ${urlRegistro} y haz clic en "Crear mi cuenta de acceso" usando exactamente este correo: ${email}`;
                const numeroWA = telefono.replace(/\D/g, ''); 

                alert("‚úÖ Perfil creado. Se abrir√° WhatsApp para enviar las instrucciones.");
                window.open(`https://wa.me/${numeroWA}?text=${encodeURIComponent(mensaje)}`, '_blank');

                document.getElementById('modalNuevoStaff').classList.add('hidden');
                e.target.reset();
                cargarStaff();
            } catch (err) {
                alert("‚ùå Error: " + err.message);
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        });

        // PLANES & DASHBOARD
        async function cargarPlanes() {
            const select = document.getElementById('planElegido');
            if(!select) return;
            
            select.innerHTML = '<option value="">Cargando planes...</option>';

            // ¬°AQU√ç EST√Å LA MAGIA DEL FILTRO! Solo los planes de este tenant
            const { data, error } = await miSupabase
                .from('planes')
                .select('*')
                .eq('tenant_id', miTenantId) 
                .order('precio');

            if (error) {
                console.error("Error cargando planes:", error);
                return;
            }

            if (data && data.length > 0) {
                // Guardamos el precio en un data-attribute para usarlo al enviar el formulario
                select.innerHTML = data.map(p => 
                    `<option value="${p.id}" data-meses="${Math.max(1, Math.round(p.dias_duracion / 30))}" data-precio="${p.precio}">
                        ${p.nombre_plan} - $${p.precio}
                    </option>`
                ).join('');
            } else {
                select.innerHTML = '<option value="">Sin planes (Ve a Ajustar Precios)</option>';
            }
        }

        async function cargarDatosYDashboard() {
            try {
                // 1. Traer Clientes del Backend (Cloudflare)
                const res = await fetch(API_URL, { headers: { 'Authorization': `Bearer ${tokenActual}` } });
                let clientesCrudos = await res.json();
                const clientes = clientesCrudos.filter(c => c.tenant_id === miTenantId);

                // 2. Traer Historial de Pagos (Supabase)
                const { data: historial, error: histError } = await miSupabase
                    .from('historial_suscripciones')
                    .select('*')
                    .eq('tenant_id', miTenantId);

                // 3. LA MAGIA: Unir el historial con los clientes y calcular estado
                const clientesConHistorial = clientes.map(cliente => {
                    const subs = historial && !histError ? historial.filter(h => h.suscriptor_id === cliente.id) : [];
                    subs.sort((a, b) => new Date(b.fecha_fin) - new Date(a.fecha_fin));
                    const ultimaSub = subs[0];
                    
                    // Pre-calculamos el estado una sola vez para usarlo en los filtros
                    let estadoCalculado = 'Sin plan';
                    if (ultimaSub && ultimaSub.fecha_fin) {
                        const diffTime = new Date() - new Date(ultimaSub.fecha_fin);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 30) estadoCalculado = 'Inactivo';
                        else if (diffDays > 0 && diffDays <= 30) estadoCalculado = 'Atrasado';
                        else estadoCalculado = 'Activo';
                    }

                    return {
                        ...cliente,
                        historial_suscripciones: subs,
                        estado_calculado: estadoCalculado // <--- Guardamos el dato listo para usar
                    };
                });

                // 4. Renderizar la tabla con los datos completos
                listaClientesOriginal = clientesConHistorial; 
                //renderizarTablaClientes(clientesConHistorial);
                filtrarClientes(); 

                // 5. KPIs de L√≠mites del Plan SaaS
                totalClientesActual = clientes.length;
                document.getElementById('kpiTotal').innerText = totalClientesActual;
                document.getElementById('kpiLimite').innerText = limiteClientesActual;

                const barra = document.getElementById('barraUsoPlan');
                const nombrePlan = document.getElementById('nombrePlanSaas');
                if (barra) {
                    let porcentajeUso = limiteClientesActual > 0 
                        ? (totalClientesActual / limiteClientesActual) * 100 
                        : 0;
                    if (porcentajeUso > 100) porcentajeUso = 100;
                    barra.style.width = `${porcentajeUso}%`;
                    barra.className = `transition-all duration-700 h-2 rounded-full ${porcentajeUso >= 90 ? 'bg-red-500' : 'bg-emerald-500'}`;
                }
                if (nombrePlan) nombrePlan.innerText = planSaasActual;

                // 6. KPIs de Estado (Aplicando la nueva regla de 30 d√≠as)
                let contAlDia = 0;
                let contAtrasados = 0;

                clientesConHistorial.forEach(c => {
                    const subs = c.historial_suscripciones || [];
                    // Ordenamos para obtener el pago m√°s reciente
                    subs.sort((a, b) => new Date(b.fecha_fin) - new Date(a.fecha_fin));
                    const ultimaSub = subs[0];

                    if (ultimaSub && ultimaSub.fecha_fin) {
                        const diffTime = new Date() - new Date(ultimaSub.fecha_fin);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays <= 0) {
                            contAlDia++; // Tiene d√≠as a favor
                        } else if (diffDays > 0 && diffDays <= 30) {
                            contAtrasados++; // Atrasado (periodo de gracia)
                        }
                        // Si diffDays > 30, es "Inactivo" y no suma en estas dos gr√°ficas principales
                    }
                });

                const elementoAlDia = document.getElementById('kpiAlDia');
                const elementoAtrasados = document.getElementById('kpiMorosos');
                if (elementoAlDia) elementoAlDia.innerText = contAlDia;
                if (elementoAtrasados) elementoAtrasados.innerText = contAtrasados;
                
                actualizarGrafico(contAlDia, contAtrasados);

            } catch (error) { 
                console.error("Error al cargar el dashboard:", error); 
            }
        }

        function actualizarGrafico(alDia, morosos) {
            const ctx = document.getElementById('graficoPagos').getContext('2d');
            if (graficoInstancia) graficoInstancia.destroy();
            graficoInstancia = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Al D√≠a', 'Atrasados'],
                    datasets: [{ data: [alDia, morosos], backgroundColor: ['#10B981', '#EF4444'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '72%' }
            });
        }

        // PERMISOS
        function aplicarPermisos(rol) {
            document.querySelectorAll('.solo-admin').forEach(el =>
                rol === 'recepcionista' ? el.classList.add('hidden') : el.classList.remove('hidden')
            );
        }

        async function subirLogo(input) {
            const archivo = input.files[0];
            if (!archivo) return;

            // --- NUEVA VALIDACI√ìN DE TAMA√ëO (1 MB) ---
            if (archivo.size > 1048576) {
                alert("‚ö†Ô∏è El archivo es demasiado grande. Por favor, sube un logo que pese menos de 1 MB.");
                input.value = ''; // Limpiamos el input para que pueda intentar de nuevo
                return;
            }

            const imgElement = document.getElementById('logoGymImg');
            imgElement.src = "https://via.placeholder.com/150?text=Subiendo...";
            try {
                const fileName = `${miTenantId}/logo_${Date.now()}.png`;
                await miSupabase.storage.from('logos').upload(fileName, archivo);
                const { data: urlData } = miSupabase.storage.from('logos').getPublicUrl(fileName);
                await miSupabase.from('tenants').update({ logo_url: urlData.publicUrl }).eq('id', miTenantId);
                imgElement.src = urlData.publicUrl;
            } catch (e) { alert("Error al subir"); }
        }

        async function eliminarStaff(id) {
            if (confirm("¬øEliminar este miembro del equipo?")) {
                await miSupabase.from('perfiles_staff').delete().eq('id', id);
                cargarStaff();
            }
        }

        function mostrarPaseQR(id, nombre, tel, fotoUrl) {
            document.getElementById('modalQR').classList.remove('hidden');
            document.getElementById('nombreClienteQR').innerText = nombre;
            
            // L√≥gica de la Foto: Si no tiene, creamos un avatar con sus iniciales autom√°ticamente
            const imgEl = document.getElementById('fotoClienteQR');
            if (fotoUrl && fotoUrl !== 'null' && fotoUrl !== '') {
                imgEl.src = fotoUrl;
            } else {
                imgEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=10B981&color=fff&size=150`;
            }

            const cont = document.getElementById('contenedorQR'); 
            cont.innerHTML = '';
            new QRCode(cont, { text: `https://wide-waves-shave.loca.lt/checkin/${id}`, width: 220, height: 220 });
            
            document.getElementById('btnEnviarWA').onclick = () =>
                window.open(`https://wa.me/${tel.replace(/\D/g,'')}?text=Hola ${nombre}, aqu√≠ tienes tu pase QR de acceso al gimnasio.`, '_blank');
        }

        let html5QrCode;
        function abrirEscanner() {
            document.getElementById('lectorQRContainer').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                html5QrCode.stop().then(() => window.location.href = txt);
            });
        }
        function cerrarEscanner() {
            if (html5QrCode) html5QrCode.stop().then(() => document.getElementById('lectorQRContainer').classList.add('hidden'));
            else document.getElementById('lectorQRContainer').classList.add('hidden');
        }

        document.getElementById('formUpdatePassword').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { error } = await miSupabase.auth.updateUser({ password: document.getElementById('newPassword').value });
            if (!error) { alert("‚úÖ Contrase√±a actualizada."); await miSupabase.auth.signOut(); location.reload(); }
            else alert("Error: " + error.message);
        });

        miSupabase.auth.onAuthStateChange((event, session) => {
            if (event === "PASSWORD_RECOVERY") {
                modoRecuperacion = true;
                document.getElementById('pantallaLogin').classList.add('hidden');
                document.getElementById('modalPassword').classList.remove('hidden');
                alert("üëã ¬°Bienvenido al equipo! Por favor, crea tu nueva contrase√±a para activar tu cuenta.");
            }
        });

        function cancelarReset() {
            document.getElementById('modalPassword').classList.add('hidden');
            if (modoRecuperacion) { miSupabase.auth.signOut(); location.reload(); }
        }
        async function solicitarResetPassword() {
            const email = document.getElementById('emailLogin').value;
            if (!email) return alert("‚ö†Ô∏è Ingresa tu correo primero.");
            const { error } = await miSupabase.auth.resetPasswordForEmail(email, { redirectTo: 'http://127.0.0.1:5500/frontend/index.html' });
            if (!error) alert("üì© Enlace enviado.");
        }
        function cerrarSesion() { miSupabase.auth.signOut(); location.reload(); }

        function abrirRegistro() {
            document.getElementById('modalRegistro').classList.remove('hidden');
            document.getElementById('pantallaLogin').classList.add('hidden');
        }
        function cerrarRegistro() {
            document.getElementById('modalRegistro').classList.add('hidden');
            document.getElementById('pantallaLogin').classList.remove('hidden');
        }

        document.getElementById('formRegistro').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('emailRegistro').value;
            const password = document.getElementById('passRegistro').value;

            // --- NUEVA VALIDACI√ìN ---
            const emailConfirm = document.getElementById('emailRegistroConfirm').value;
            const passConfirm = document.getElementById('passRegistroConfirm').value;

            if (email !== emailConfirm) {
                alert("‚ö†Ô∏è Los correos electr√≥nicos no coinciden.");
                return;
            }
            if (password !== passConfirm) {
                alert("‚ö†Ô∏è Las contrase√±as no coinciden.");
                return;
            }
            // ------------------------

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Verificando...'; btn.disabled = true;

            try {
                const { data: estaAutorizado, error: rpcError } = await miSupabase.rpc('verificar_invitacion', { correo: email });
                if (rpcError) throw new Error("Error al consultar el directorio de invitaciones.");
                if (!estaAutorizado) throw new Error("Acceso denegado: Un administrador debe registrar este correo en el sistema primero.");

                btn.innerHTML = 'Creando cuenta...';
                const { data, error } = await miSupabase.auth.signUp({
                    email, password,
                    options: { emailRedirectTo: window.location.href }
                });
                if (error) throw error;

                alert("‚úÖ ¬°Cuenta creada con √©xito! Revisa tu bandeja de entrada/spam y confirma tu correo.");
                e.target.reset();
                cerrarRegistro();
                document.getElementById('emailLogin').value = email;
                document.getElementById('passLogin').focus();
            } catch (err) {
                console.error("Error en registro:", err);
                alert("‚ùå " + err.message);
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        });

        // TABLA DE CLIENTES (INTACTA - EXACTAMENTE COMO LA TIENES)
        function renderizarTablaClientes(arreglo) {
            const tbody = document.getElementById('tablaCuerpo');
            if (!tbody) return;

            tbody.innerHTML = arreglo.map(c => {
                // 1. Obtener la suscripci√≥n m√°s reciente
                const subs = c.historial_suscripciones || [];
                subs.sort((a, b) => new Date(b.fecha_fin) - new Date(a.fecha_fin));
                const ultimaSub = subs[0] || {};
                
                // 2. Formatear datos de inter√©s
                const vence = ultimaSub.fecha_fin ? new Date(ultimaSub.fecha_fin).toLocaleDateString('es-ES') : '<span class="text-gray-400">Sin plan</span>';
                const fechaRegistro = c.fecha_registro || c.created_at; // Soporte para ambos nombres de columna
                const registrado = fechaRegistro ? new Date(fechaRegistro).toLocaleDateString('es-ES') : 'Desconocido';
                const emergencia = c.contacto_emergencia || '<span class="text-gray-400 italic">No registrado</span>';

                // 3. L√≥gica Estricta de Estado (Atrasado <= 30 d√≠as, Inactivo > 30 d√≠as)
                let estadoTexto = ultimaSub.estado_pago || 'Sin plan';
                let badgeClass = 'bg-gray-100 text-gray-700';

                if (ultimaSub.fecha_fin) {
                    const diffTime = new Date() - new Date(ultimaSub.fecha_fin);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 30) {
                        estadoTexto = 'Inactivo';
                        badgeClass = 'bg-red-100 text-red-700';
                    } else if (diffDays > 0 && diffDays <= 30) {
                        estadoTexto = 'Atrasado';
                        badgeClass = 'bg-yellow-100 text-yellow-700';
                    } else {
                        estadoTexto = 'Activo';
                        badgeClass = 'bg-emerald-100 text-emerald-700';
                    }
                }

                const badgeEstado = `<span class="px-2.5 py-1 rounded-md text-[11px] font-bold uppercase ${badgeClass}">${estadoTexto}</span>`;

                return `
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <img src="${c.foto_url || 'https://ui-avatars.com/api/?name='+encodeURIComponent(c.nombre_completo)+'&background=10B981&color=fff'}" class="w-8 h-8 rounded-full object-cover">
                                <span class="text-sm font-bold text-gray-800">${c.nombre_completo}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-700">üìû ${c.telefono || 'Sin tel√©fono'}</div>
                            <div class="text-xs text-gray-400 mt-0.5">üì© ${c.email || 'Sin correo'}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${emergencia}</td>
                        <td class="px-6 py-4">${badgeEstado}</td>
                        <td class="px-6 py-4 text-sm text-gray-600 font-medium">${vence}</td>
                        <td class="px-6 py-4 text-sm text-gray-400">${registrado}</td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end items-center gap-2">
                                <button onclick="abrirModalRenovar('${c.id}', '${c.nombre_completo}')"
                                    class="bg-amber-50 text-amber-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-amber-100 transition shadow-sm" title="Renovar o Cambiar Plan">
                                    üîÑ Renovar
                                </button>
                                
                                <button onclick="mostrarPaseQR('${c.id}', '${c.nombre_completo}', '${c.telefono}', '${c.foto_url || ''}')"
                                    class="bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-emerald-100 transition shadow-sm">
                                    üì± QR
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // FUNCI√ìN DE FILTRADO (AHORA SOPORTA FILTRO DOBLE POR DEFECTO)
        function filtrarClientes() {
            const texto = document.getElementById('inputBuscarCliente').value.toLowerCase();
            const filtroEstado = document.getElementById('filtroEstado') ? document.getElementById('filtroEstado').value : 'Activos y Atrasados';

            const filtrados = listaClientesOriginal.filter(c => {
                const coincideTexto = 
                    (c.nombre_completo && c.nombre_completo.toLowerCase().includes(texto)) ||
                    (c.email && c.email.toLowerCase().includes(texto));

                let coincideEstado = true; 
                
                if (filtroEstado !== 'Todos') {
                    const subs = c.historial_suscripciones || [];
                    const subsOrdenadas = [...subs].sort((a, b) => new Date(b.fecha_fin) - new Date(a.fecha_fin));
                    const ultimaSub = subsOrdenadas[0] || {};
                    
                    let estadoCalculado = ultimaSub.estado_pago || 'Sin plan';
                    
                    if (ultimaSub.fecha_fin) {
                        const diffTime = new Date() - new Date(ultimaSub.fecha_fin);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays > 30) estadoCalculado = 'Inactivo';
                        else if (diffDays > 0 && diffDays <= 30) estadoCalculado = 'Atrasado';
                        else estadoCalculado = 'Activo';
                    }

                    // APLICAMOS LA NUEVA REGLA (Permitir Activos OR Atrasados)
                    if (filtroEstado === 'Activos y Atrasados') {
                        coincideEstado = (estadoCalculado === 'Activo' || estadoCalculado === 'Atrasado');
                    } else {
                        coincideEstado = (estadoCalculado === filtroEstado);
                    }
                }

                return coincideTexto && coincideEstado;
            });

            renderizarTablaClientes(filtrados);
        }

        // REGISTRO NUEVO SUSCRIPTOR
        document.getElementById('formSuscriptor').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (totalClientesActual >= limiteClientesActual) {
                prepararYAbrirModalUpgrade(); return;
            }

            // --- NUEVA VALIDACI√ìN: TAMA√ëO DE LA FOTO (M√ÅXIMO 1 MB) ---
            const inputFoto = document.getElementById('fotoInput');
            if (inputFoto && inputFoto.files[0]) {
                const tama√±oBytes = inputFoto.files[0].size;
                if (tama√±oBytes > 1048576) { // 1048576 bytes = 1 MB
                    alert("‚ö†Ô∏è La foto del cliente es demasiado grande. Por favor, aseg√∫rate de que pese menos de 1 MB.");
                    inputFoto.value = ''; // Limpiamos el input para que pueda elegir otra sin recargar
                    return; // Detenemos la ejecuci√≥n aqu√≠ mismo
                }
            }
            // ---------------------------------------------------------

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Guardando...'; btn.disabled = true;

            try {
                let fotoUrl = null;
                const inputFoto = document.getElementById('fotoInput');
                
                if (inputFoto && inputFoto.files[0]) {
                    const fotoFile = inputFoto.files[0];
                    const fileName = `${miTenantId}/${Date.now()}_socio.png`;
                    const { data } = await miSupabase.storage.from('avatars').upload(fileName, fotoFile);
                    if (data) fotoUrl = miSupabase.storage.from('avatars').getPublicUrl(fileName).data.publicUrl;
                }

                const sel = document.getElementById('planElegido');
                const nuevoCliente = {
                    tenant_id: miTenantId,
                    nombre_completo: document.getElementById('nombre').value,
                    telefono: document.getElementById('telefono').value,
                    email: document.getElementById('email').value,
                    plan_id: sel.value,
                    meses_duracion: sel.options[sel.selectedIndex].getAttribute('data-meses'),
                    foto_url: fotoUrl,
                    contacto_emergencia: document.getElementById('contactoEmergencia').value,

                    // NUEVO: Capturamos si el switch est√° encendido (true/false)
                    renovacion_automatica: document.getElementById('renovacionAutoCliente').checked
                };

                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${tokenActual}` },
                    body: JSON.stringify(nuevoCliente)
                });
                if (!res.ok) throw new Error("Error al guardar el cliente en el servidor.");

                // --- NUEVO: LLENAMOS Y MOSTRAMOS EL MODAL DE √âXITO ---
                const nombrePlanTexto = sel.options[sel.selectedIndex].text;
                document.getElementById('resNombre').innerText = nuevoCliente.nombre_completo;
                document.getElementById('resTelefono').innerText = nuevoCliente.telefono;
                document.getElementById('resEmail').innerText = nuevoCliente.email;
                document.getElementById('resEmergencia').innerText = nuevoCliente.contacto_emergencia || 'No registrado';
                document.getElementById('resPlan').innerText = nombrePlanTexto;
                
                document.getElementById('modalExitoCliente').classList.remove('hidden');

                e.target.reset();
                if(document.getElementById('fotoInput')) document.getElementById('fotoInput').value = '';
                await cargarDatosYDashboard();
            } catch (err) {
                console.error("Error al registrar suscriptor:", err);
                alert("‚ùå Error: " + err.message);
            } finally {
                btn.innerHTML = originalText; btn.disabled = false;
            }
        });

        // MODAL UPGRADE
        function prepararYAbrirModalUpgrade() {
            const titulo = document.getElementById('tituloPlanUpsell');
            const lista = document.getElementById('listaFeaturesUpsell');
            const btn = document.getElementById('btnPagarUpgrade');

            if (planSaasActual.toLowerCase() === 'starter') {
                titulo.innerText = 'Plan Pro ‚Äî $69/mes';
                lista.innerHTML = `
                    <li class="flex items-center gap-2">‚úÖ <span class="font-semibold">Hasta 500 clientes activos</span></li>
                    <li class="flex items-center gap-2">‚úÖ Usuarios de Staff ilimitados</li>
                    <li class="flex items-center gap-2">‚úÖ Recordatorios autom√°ticos por WhatsApp</li>`;
                btn.innerHTML = 'Mejorar a Plan Pro <span>üí≥</span>';
            } else if (planSaasActual.toLowerCase() === 'pro') {
                titulo.innerText = 'Plan Elite ‚Äî $149/mes';
                lista.innerHTML = `
                    <li class="flex items-center gap-2">‚úÖ <span class="font-semibold">Clientes y Staff Ilimitados</span></li>
                    <li class="flex items-center gap-2">‚úÖ Reportes avanzados de retenci√≥n</li>
                    <li class="flex items-center gap-2">‚úÖ Soporte Prioritario 24/7</li>`;
                btn.innerHTML = 'Mejorar a Plan Elite <span>üí≥</span>';
            } else {
                titulo.innerText = 'Ampliaci√≥n de Capacidad';
                lista.innerHTML = `<li class="flex items-center gap-2">‚úÖ <span class="font-semibold">Aumenta tu l√≠mite actual de servidor</span></li>`;
                btn.innerHTML = 'Contactar a Soporte <span>üéß</span>';
            }
            document.getElementById('modalUpgrade').classList.remove('hidden');
        }

        // --- SISTEMA DE NAVEGACI√ìN COMPLETO (ACTUALIZADO) ---
        function cambiarVista(vistaDestino) {
            // 1. Mapear pantallas
            const vistas = {
                'resumen': document.getElementById('vistaResumen'),
                'finanzas': document.getElementById('vistaFinanzas'),
                'staff': document.getElementById('vistaStaff'),
                'escanear': document.getElementById('vistaEscanear')
            };

            // 2. Apagar todas las pantallas
            Object.values(vistas).forEach(pantalla => {
                if (pantalla) pantalla.classList.add('hidden');
            });

            // 3. Encender la pantalla solicitada
            if (vistas[vistaDestino]) vistas[vistaDestino].classList.remove('hidden');

            // --- NUEVO: ACTUALIZAR ESTADO DEL MEN√ö LATERAL ---
            // A) Apagamos todos los botones (quitamos 'active', ponemos texto opaco)
            document.querySelectorAll('.nav-link').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-white/70');
            });

            // B) Encendemos solo el bot√≥n correcto
            const mapaBotones = {
                'resumen': 'btnNavDashboard',
                'staff': 'btnNavStaff',
                'finanzas': 'btnMenuFinanzas'
            };
            
            const btnActivo = document.getElementById(mapaBotones[vistaDestino]);
            if (btnActivo) {
                btnActivo.classList.add('active');
                btnActivo.classList.remove('text-white/70');
            } else if (vistaDestino === 'escanear') {
                // En caso de que el bot√≥n de escanear no tenga ID
                const btnEsc = document.querySelector('a[onclick="cambiarVista(\'escanear\')"]');
                if (btnEsc) {
                    btnEsc.classList.add('active');
                    btnEsc.classList.remove('text-white/70');
                }
            }

            // 4. Ejecutar l√≥gicas adicionales
            if (vistaDestino === 'finanzas') cargarDashboardFinanciero();
            else if (vistaDestino === 'staff') cargarStaff();
        }

        // Variables globales para evitar duplicar gr√°ficos al hacer clics m√∫ltiples
        let chartFlujo = null;
        let chartPlanes = null;

        // --- L√ìGICA DEL DASHBOARD FINANCIERO ---
        // --- L√ìGICA DEL DASHBOARD FINANCIERO ---
        async function cargarDashboardFinanciero() {
            const paywall = document.getElementById('paywallFinanzas');
            
            // 1. GATEKEEPER SAAS
            if (planSaasActual.toLowerCase() !== 'elite') {
                paywall.classList.remove('hidden');
                return; 
            } else {
                paywall.classList.add('hidden');
            }

            try {
                // 2. EXTRAER DATOS REALES DE SUPABASE
                // IMPORTANTE: A√±ad√≠ suscriptor_id y fecha_inicio para poder calcular el MRR pasado y los clientes √∫nicos
                const { data: historial, error } = await miSupabase
                    .from('historial_suscripciones')
                    .select(`
                        suscriptor_id,
                        estado_pago,
                        fecha_inicio,
                        fecha_fin,
                        precio_cobrado, 
                        planes ( nombre_plan, dias_duracion )
                    `)
                    .eq('tenant_id', miTenantId);

                if (error) throw error;

                // 3. VARIABLES PARA MATEM√ÅTICAS AVANZADAS
                let mrrActual = 0;
                let mrrPasado = 0;
                
                let ingresosPorPlan = {}; 
                let cashFlow15Dias = Array(15).fill(0); 
                
                // Definici√≥n estricta de tiempos
                const hoy = new Date();
                const anioActual = hoy.getFullYear();
                const mesActual = hoy.getMonth();
                
                const inicioMesActual = new Date(anioActual, mesActual, 1);
                const finMesActual = new Date(anioActual, mesActual + 1, 0);

                const inicioMesPasado = new Date(mesActual === 0 ? anioActual - 1 : anioActual, mesActual === 0 ? 11 : mesActual - 1, 1);
                const finMesPasado = new Date(mesActual === 0 ? anioActual - 1 : anioActual, mesActual === 0 ? 12 : mesActual, 0);

                const limite15Dias = new Date();
                limite15Dias.setDate(hoy.getDate() + 15);

                const subsPorCliente = {}; // Para agrupar usuarios √∫nicos y calcular Churn

                // 4. PROCESAMIENTO DE DATOS
                historial.forEach(sub => {
                    const fInicio = new Date(sub.fecha_inicio);
                    const fFin = new Date(sub.fecha_fin);
                    const precio = parseFloat(sub.precio_cobrado) || 0; 
                    const dias = sub.planes?.dias_duracion || 30;
                    const nombrePlan = sub.planes?.nombre_plan || 'Plan Gen√©rico';
                    
                    const meses = Math.max(1, Math.round(dias / 30));
                    const ingresoMensualReal = precio / meses;

                    // A. MRR MES ACTUAL (Solo dinero de suscripciones activas durante este mes exacto)
                    if (fInicio <= finMesActual && fFin >= inicioMesActual) {
                        mrrActual += ingresoMensualReal;
                        if (!ingresosPorPlan[nombrePlan]) ingresosPorPlan[nombrePlan] = 0;
                        ingresosPorPlan[nombrePlan] += ingresoMensualReal;
                    }

                    // B. MRR MES ANTERIOR (Para comparar)
                    if (fInicio <= finMesPasado && fFin >= inicioMesPasado) {
                        mrrPasado += ingresoMensualReal;
                    }

                    // C. FLUJO DE CAJA A 15 D√çAS
                    if (fFin >= hoy && fFin <= limite15Dias) {
                        const diffTime = Math.abs(fFin - hoy);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays >= 0 && diffDays < 15) {
                            cashFlow15Dias[diffDays] += precio; 
                        }
                    }

                    // Agrupamos la √∫ltima fecha de cada cliente para el Churn
                    if (!subsPorCliente[sub.suscriptor_id] || new Date(subsPorCliente[sub.suscriptor_id].fecha_fin) < fFin) {
                        subsPorCliente[sub.suscriptor_id] = sub;
                    }
                });

                // 5. C√ÅLCULO DE CHURN Y RETENCI√ìN (Solo vencimientos del a√±o actual, >30 d√≠as)
                let retenidosAnio = 0;
                let churnedAnio = 0;

                Object.values(subsPorCliente).forEach(ultimaSub => {
                    const fFin = new Date(ultimaSub.fecha_fin);
                    if (fFin.getFullYear() === anioActual) {
                        const diffTime = hoy - fFin;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays > 30) {
                            churnedAnio++; // Inactivo oficialmente
                        } else {
                            retenidosAnio++; // Activo o Atrasado (retenible)
                        }
                    }
                });

                const totalAnio = retenidosAnio + churnedAnio;
                let churn = 0;
                let retencion = 100;
                if (totalAnio > 0) {
                    churn = Math.round((churnedAnio / totalAnio) * 100);
                    retencion = 100 - churn;
                }

                // 6. ACTUALIZAR HTML (KPIs)
                document.getElementById('kpiMRR').innerText = mrrActual.toFixed(2);
                document.getElementById('kpiRetencion').innerText = retencion;
                document.getElementById('kpiChurn').innerText = churn;

                // C√ÅLCULO DIN√ÅMICO DE CRECIMIENTO MRR (%)
                let crecimiento = 0;
                if (mrrPasado > 0) {
                    crecimiento = ((mrrActual - mrrPasado) / mrrPasado) * 100;
                } else if (mrrActual > 0) {
                    crecimiento = 100;
                }

                // NUEVO: APUNTAMOS DIRECTAMENTE AL ID EXACTO
                const spanCrecimiento = document.getElementById('kpiCrecimiento');
                if (spanCrecimiento) {
                    const esPositivo = crecimiento >= 0;
                    spanCrecimiento.innerText = esPositivo ? `+${crecimiento.toFixed(1)}% vs mes anterior` : `${crecimiento.toFixed(1)}% vs mes anterior`;
                    
                    // Colores din√°micos: Verde si sube o se mantiene, Rojo si cae
                    spanCrecimiento.className = esPositivo 
                        ? 'text-xs font-bold px-2 py-1 rounded-md text-emerald-600 bg-emerald-50 mt-2 inline-block transition-all' 
                        : 'text-xs font-bold px-2 py-1 rounded-md text-red-600 bg-red-50 mt-2 inline-block transition-all';
                }

                // 7. PREPARAR DATOS PARA GR√ÅFICOS (Tu c√≥digo intacto)
                const etiquetasDias = Array.from({length: 15}, (_, i) => {
                    if (i === 0) return 'Hoy';
                    if (i === 1) return 'Ma√±ana';
                    let d = new Date();
                    d.setDate(d.getDate() + i);
                    return d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }); 
                });
                
                const etiquetasPlanes = Object.keys(ingresosPorPlan);
                const datosPlanes = Object.values(ingresosPorPlan);

                // 8. RENDERIZAR GR√ÅFICO DE FLUJO DE CAJA (Tu c√≥digo intacto)
                const ctxFlujo = document.getElementById('graficoFlujoCaja').getContext('2d');
                if (window.chartFlujo) window.chartFlujo.destroy(); // Ajuste menor preventivo
                
                window.chartFlujo = new Chart(ctxFlujo, {
                    type: 'bar',
                    data: {
                        labels: etiquetasDias,
                        datasets: [{
                            label: 'Renovaciones Proyectadas ($)',
                            data: cashFlow15Dias,
                            backgroundColor: '#10B981',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // 9. RENDERIZAR GR√ÅFICO DE ANILLO (Tu c√≥digo intacto)
                const ctxPlanes = document.getElementById('graficoPlanes').getContext('2d');
                if (window.chartPlanes) window.chartPlanes.destroy(); // Ajuste menor preventivo
                
                const colores = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];

                window.chartPlanes = new Chart(ctxPlanes, {
                    type: 'doughnut',
                    data: {
                        labels: etiquetasPlanes.length > 0 ? etiquetasPlanes : ['Sin datos'],
                        datasets: [{
                            data: datosPlanes.length > 0 ? datosPlanes : [1],
                            backgroundColor: colores.slice(0, etiquetasPlanes.length || 1),
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        cutout: '70%'
                    }
                });

            } catch (error) {
                console.error("Error al cargar datos financieros:", error);
            }
        }

        // --- L√ìGICA DE GESTI√ìN DE PLANES Y PRECIOS ---
        let planesActualesAdmin = [];

        // 1. DIBUJAR LOS PLANES EXISTENTES (AHORA CON BOT√ìN DE BORRAR)
        async function abrirModalPlanes() {
            document.getElementById('modalAjustarPlanes').classList.remove('hidden');
            const cont = document.getElementById('contenedorPlanesDinamicos');
            cont.innerHTML = '<p class="text-sm text-gray-500 text-center italic">Cargando...</p>';
            
            const { data, error } = await miSupabase.from('planes').select('*').eq('tenant_id', miTenantId).order('precio');
            
            if (data && data.length > 0) {
                planesActualesAdmin = data;
                cont.innerHTML = data.map(p => `
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex flex-col gap-1 shadow-sm relative">
                        <button type="button" onclick="borrarPlan('${p.id}')" class="absolute top-2 right-2 text-red-300 hover:text-red-600 transition" title="Borrar Plan">
                            üóëÔ∏è
                        </button>
                        
                        <label class="block text-[11px] font-extrabold text-gray-500 uppercase tracking-wider pr-6">${p.nombre_plan} <span class="text-gray-400 font-medium lowercase">(${p.dias_duracion} d√≠as)</span></label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 font-bold">$</span>
                            <input type="number" step="0.01" id="precio_plan_${p.id}" value="${p.precio}" 
                                class="w-full border border-gray-200 bg-gray-50 pl-8 pr-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-emerald-400 text-sm font-bold text-emerald-700 transition">
                        </div>
                    </div>
                `).join('');
            } else {
                cont.innerHTML = '<p class="text-sm text-red-500 text-center font-bold mt-4">No tienes planes configurados.</p>';
            }
        }

        // 2. GUARDAR ACTUALIZACI√ìN DE PRECIOS (CON VALIDACI√ìN ESTRICTA)
        document.getElementById('formAjustarPlanes').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = 'Guardando... ‚è≥'; btn.disabled = true;
            
            try {
                for (const plan of planesActualesAdmin) {
                    const inputPrecio = document.getElementById(`precio_plan_${plan.id}`);
                    const nuevoPrecio = parseFloat(inputPrecio.value);
                    
                    // Actualizamos y exigimos confirmaci√≥n de Supabase (.select)
                    const { data, error } = await miSupabase
                        .from('planes')
                        .update({ precio: nuevoPrecio })
                        .eq('id', plan.id)
                        .select();
                        
                    if (error) throw error;
                    // Si Supabase devuelve un arreglo vac√≠o, significa que RLS lo bloque√≥
                    if (!data || data.length === 0) throw new Error("Cambio bloqueado. Verifica que RLS est√© desactivado en la tabla planes.");
                }
                
                alert("‚úÖ Precios actualizados correctamente en la base de datos.");
                document.getElementById('modalAjustarPlanes').classList.add('hidden');
                
                if (typeof cargarPlanes === 'function') await cargarPlanes(); 
                if (typeof cargarDashboardFinanciero === 'function') await cargarDashboardFinanciero();
                
            } catch (err) {
                console.error(err);
                alert("‚ùå Ocurri√≥ un error al actualizar: " + err.message);
            } finally {
                btn.innerHTML = textoOriginal; btn.disabled = false;
            }
        });

        // 3. NUEVO: FUNCI√ìN PARA BORRAR PLANES
        async function borrarPlan(idPlan) {
            // Doble confirmaci√≥n por seguridad
            if(!confirm("‚ö†Ô∏è ¬øEst√°s totalmente seguro de que deseas borrar este plan?")) return;
            
            try {
                const { error } = await miSupabase.from('planes').delete().eq('id', idPlan);
                
                if (error) {
                    // Si el error es por Llave For√°nea, se lo explicamos amablemente al usuario
                    if (error.message.includes('foreign key') || error.code === '23503') {
                        throw new Error("No puedes borrar este plan porque ya tienes clientes o un historial asociado a √©l. Intenta simplemente cambiarle el precio.");
                    }
                    throw error;
                }
                
                alert("üóëÔ∏è Plan eliminado exitosamente.");
                
                // Refrescamos la UI
                await abrirModalPlanes(); 
                if (typeof cargarPlanes === 'function') await cargarPlanes();
                
            } catch (err) {
                console.error("Error al borrar:", err);
                alert("‚ùå " + err.message);
            }
        }

        // 4. CREAR UN NUEVO PLAN DESDE CERO
        document.getElementById('formNuevoPlan').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = 'Creando... ‚è≥'; btn.disabled = true;

            try {
                const nombrePlan = document.getElementById('nuevoPlanNombre').value;
                const precioPlan = parseFloat(document.getElementById('nuevoPlanPrecio').value);
                const diasPlan = parseInt(document.getElementById('nuevoPlanDias').value);

                const { error } = await miSupabase.from('planes').insert([{
                    tenant_id: miTenantId,
                    nombre_plan: nombrePlan,
                    precio: precioPlan,
                    dias_duracion: diasPlan
                }]);

                if (error) throw error;

                alert("‚úÖ ¬°Nuevo plan a√±adido con √©xito!");
                e.target.reset(); 
                
                await abrirModalPlanes(); 
                if (typeof cargarPlanes === 'function') await cargarPlanes(); 

            } catch (err) {
                console.error(err);
                alert("‚ùå Error al crear el plan: " + err.message);
            } finally {
                btn.innerHTML = textoOriginal; btn.disabled = false;
            }
        });

        // --- MOTOR AUTOMATIZADO DE COBROS Y RECORDATORIOS (REGLAS ESTRICTAS) ---
        async function simularMotorCobros() {
            const btn = window.event ? window.event.currentTarget : document.querySelector('button');
            const textoOriginal = btn ? btn.innerHTML : 'Ejecutar';
            if(btn) { btn.innerHTML = 'Procesando... ‚è≥'; btn.disabled = true; }

            try {
                console.log("==================================================");
                console.log("üöÄ INICIANDO MOTOR DE FACTURACI√ìN...");
                
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0); 
                console.log(`üìÖ Sistema corriendo para el d√≠a: ${hoy.toLocaleDateString()}`);

                let resumenWA_Cobro = 0;
                let resumenWA_Aviso = 0;
                let resumenCobros = 0;

                const { data: suscripciones, error } = await miSupabase
                    .from('historial_suscripciones')
                    .select(`*, planes(nombre_plan, dias_duracion), suscriptores(nombre_completo, telefono)`)
                    .eq('tenant_id', miTenantId)
                    .order('fecha_fin', { ascending: false });

                if (error) throw error;

                for (const sub of suscripciones) {
                    if (!sub.fecha_fin) continue;

                    const partesFecha = sub.fecha_fin.split('T')[0].split('-'); 
                    const fechaFin = new Date(partesFecha[0], partesFecha[1] - 1, partesFecha[2]);
                    fechaFin.setHours(0, 0, 0, 0);
                    
                    const diffTime = fechaFin - hoy;
                    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)); // Positivo = Faltan d√≠as | Negativo = Ya pas√≥

                    const nombreCliente = sub.suscriptores?.nombre_completo || 'Cliente';
                    const telefono = sub.suscriptores?.telefono || 'Sin n√∫mero';
                    const plan = sub.planes?.nombre_plan || 'Plan';
                    
                    // Preferencias del usuario
                    const renovacionAuto = sub.renovacion_automatica === true; 
                    const recordatorioEnviado = sub.recordatorio_enviado === true; 

                    // =========================================================================
                    // REGLAS 3 Y 4: NO TIENE RENOVACI√ìN AUTOM√ÅTICA -> Avisar 3 d√≠as ANTES (Una vez)
                    // =========================================================================
                    if (!renovacionAuto && diffDays === 3 && !recordatorioEnviado) {
                        const linkPago = `https://checkout.placetopay.com/simulacion/${sub.id.substring(0,8)}`; 
                        
                        console.log(`‚ñ∂Ô∏è [REGLA 3 y 4] Evaluando a: ${nombreCliente} (Vence en 3 d√≠as)`);
                        console.log(`   üí¨ WHATSAPP ENVIADO AL ${telefono}: Hola ${nombreCliente}, tu ${plan} vence en 3 d√≠as. Como no tienes renovaci√≥n autom√°tica, aqu√≠ tienes tu link para renovar tu acceso: ${linkPago}`);

                        // Marcamos para no volver a enviarlo ma√±ana
                        await miSupabase.from('historial_suscripciones').update({ recordatorio_enviado: true }).eq('id', sub.id);
                        resumenWA_Aviso++;
                    }

                    // =========================================================================
                    // REGLA 2: S√ç TIENE RENOVACI√ìN AUTOM√ÅTICA -> Cobrar 1 d√≠a DESPU√âS
                    // =========================================================================
                    // Si diffDays es -1, significa que la fecha_fin fue ayer (pas√≥ 1 d√≠a)
                    if (renovacionAuto && diffDays === -1 && sub.estado_pago !== 'Renovado') {
                        console.log(`‚ñ∂Ô∏è [REGLA 2] Evaluando a: ${nombreCliente} (Venci√≥ ayer - Procesando cobro)`);
                        console.log(`   üí≥ [PLACETOPAY] Ejecutando cargo de $${sub.precio_cobrado} a tarjeta guardada...`);
                        
                        const transaccionExitosa = true; // Simulaci√≥n
                        
                        if (transaccionExitosa) {
                            const nuevaFechaFin = new Date(hoy);
                            nuevaFechaFin.setDate(nuevaFechaFin.getDate() + (sub.planes?.dias_duracion || 30));

                            // 2.A: Insertamos el nuevo mes pagado
                            await miSupabase.from('historial_suscripciones').insert([{
                                tenant_id: miTenantId,
                                suscriptor_id: sub.suscriptor_id,
                                plan_id: sub.plan_id,
                                precio_cobrado: sub.precio_cobrado,
                                fecha_inicio: hoy.toISOString().split('T')[0],
                                fecha_fin: nuevaFechaFin.toISOString().split('T')[0],
                                estado_pago: 'Pagado',
                                renovacion_automatica: true // Mantiene su preferencia
                            }]);

                            // 2.B: Archivamos TODO el historial viejo del cliente
                            await miSupabase.from('historial_suscripciones')
                                .update({ estado_pago: 'Inactivo' })
                                .eq('suscriptor_id', sub.suscriptor_id);
                            
                            // 2.C: WhatsApp autom√°tico de recibo
                            console.log(`   ‚úÖ ¬°Cobro exitoso!`);
                            console.log(`   üí¨ WHATSAPP ENVIADO AL ${telefono}: ¬°Gracias ${nombreCliente}! Hemos procesado exitosamente la renovaci√≥n de tu ${plan}. Tienes acceso garantizado hasta el ${nuevaFechaFin.toLocaleDateString('es-ES')}.`);
                            
                            resumenCobros++;
                            resumenWA_Cobro++;
                        }
                    }
                }

                console.log("==================================================");
                
                if (resumenCobros > 0 || resumenWA_Aviso > 0) {
                    if(typeof cargarDatosYDashboard === 'function') await cargarDatosYDashboard();
                    if(typeof cargarDashboardFinanciero === 'function') await cargarDashboardFinanciero();
                }

                alert(`üìä REPORTE DEL MOTOR:\n\nüîî Avisos manuales enviados (Faltan 3 d√≠as): ${resumenWA_Aviso}\nüí≥ Renovaciones autom√°ticas cobradas (+1 d√≠a): ${resumenCobros}\nüßæ Recibos WA enviados: ${resumenWA_Cobro}\n\n(Revisa la consola F12 para leer los mensajes simulados)`);

            } catch (err) {
                console.error("‚ùå Error en el motor:", err);
                alert("‚ùå Ocurri√≥ un error al ejecutar el motor: " + err.message);
            } finally {
                if(btn) { btn.innerHTML = textoOriginal; btn.disabled = false; }
            }
        }
        
        // --- FUNCI√ìN PARA RENOVAR O CAMBIAR PLAN DE UN CLIENTE ---
        async function renovarSuscripcionCliente(suscriptorId, nuevoPlanId, precioCobrado, diasDuracion, quiereRenovacionAuto) {
            try {
                const hoy = new Date();
                const nuevaFechaFin = new Date(hoy);
                nuevaFechaFin.setDate(nuevaFechaFin.getDate() + diasDuracion);

                // 1. REGLA DE ORO: Marcar todo el historial anterior como 'Inactivo'
                // Al no filtrar por ID de suscripci√≥n, sino por ID de cliente, apagamos TODAS sus suscripciones pasadas
                const { error: errUpdate } = await miSupabase
                    .from('historial_suscripciones')
                    .update({ estado_pago: 'Inactivo' })
                    .eq('suscriptor_id', suscriptorId)
                    .eq('tenant_id', miTenantId);

                if (errUpdate) throw errUpdate;

                // 2. Insertar la nueva fila fresca como 'Pagado' (Activa)
                const { error: errInsert } = await miSupabase
                    .from('historial_suscripciones')
                    .insert([{
                        tenant_id: miTenantId,
                        suscriptor_id: suscriptorId,
                        plan_id: nuevoPlanId,
                        precio_cobrado: precioCobrado,
                        fecha_inicio: hoy.toISOString().split('T')[0],
                        fecha_fin: nuevaFechaFin.toISOString().split('T')[0],
                        estado_pago: 'Pagado', // En nuestro sistema esto significa "Activo"
                        renovacion_automatica: quiereRenovacionAuto,
                        recordatorio_enviado: false // Reseteamos el aviso de WhatsApp
                    }]);

                if (errInsert) throw errInsert;

                console.log("‚úÖ Renovaci√≥n guardada. Historial anterior archivado correctamente.");
                
                // Refrescamos la tabla para que el cliente pase de Rojo/Amarillo a Verde al instante
                if (typeof cargarDatosYDashboard === 'function') await cargarDatosYDashboard();
                
                alert("üéâ ¬°Suscripci√≥n renovada con √©xito!");

            } catch (error) {
                console.error("Error al renovar:", error);
                alert("‚ùå Error al renovar la suscripci√≥n: " + error.message);
            }
        }

        // --- L√ìGICA DE RENOVACI√ìN DE PLANES (SCD Tipo 2) ---
        async function abrirModalRenovar(clienteId, nombre) {
            // 1. Llenamos los datos visuales
            document.getElementById('renovarClienteId').value = clienteId;
            document.getElementById('renovarClienteNombre').innerText = nombre;
            document.getElementById('modalRenovarPlan').classList.remove('hidden');
            
            // 2. Cargamos los planes fresquitos de tu gimnasio
            const select = document.getElementById('renovarPlanElegido');
            select.innerHTML = '<option value="">Cargando planes...</option>';

            const { data: planes, error } = await miSupabase
                .from('planes')
                .select('*')
                .eq('tenant_id', miTenantId)
                .order('precio');

            if (planes && !error) {
                select.innerHTML = planes.map(p => 
                    `<option value="${p.id}" data-dias="${p.dias_duracion}" data-precio="${p.precio}">
                        ${p.nombre_plan} - $${p.precio}
                    </option>`
                ).join('');
            } else {
                select.innerHTML = '<option value="">Error al cargar planes</option>';
            }
        }

        function cerrarModalRenovar() {
            document.getElementById('modalRenovarPlan').classList.add('hidden');
            document.getElementById('formRenovarPlan').reset();
        }

        // 3. EVENTO DE GUARDADO (Calcula fechas din√°micas, archiva y renueva)
        document.getElementById('formRenovarPlan').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = 'Guardando... ‚è≥'; btn.disabled = true;

            try {
                const suscriptorId = document.getElementById('renovarClienteId').value;
                const selectPlan = document.getElementById('renovarPlanElegido');
                const opcionSeleccionada = selectPlan.options[selectPlan.selectedIndex];
                
                const planId = selectPlan.value;
                const precioCobrado = parseFloat(opcionSeleccionada.getAttribute('data-precio'));
                const diasDuracion = parseInt(opcionSeleccionada.getAttribute('data-dias'));
                const renovacionAuto = document.getElementById('renovarAutoSwitch').checked;

                // PASO 1: Calcular fechas din√°micas para no robarle d√≠as al cliente
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                let fechaInicioCalculada = new Date(hoy); // Por defecto arranca hoy

                // Extraemos la √∫ltima suscripci√≥n para ver cu√°ndo vence realmente
                const { data: subVieja } = await miSupabase
                    .from('historial_suscripciones')
                    .select('fecha_fin')
                    .eq('suscriptor_id', suscriptorId)
                    .order('fecha_fin', { ascending: false })
                    .limit(1);

                if (subVieja && subVieja.length > 0 && subVieja[0].fecha_fin) {
                    const partesFecha = subVieja[0].fecha_fin.split('T')[0].split('-');
                    const fechaFinAnterior = new Date(partesFecha[0], partesFecha[1] - 1, partesFecha[2]);
                    fechaFinAnterior.setHours(0, 0, 0, 0);

                    // Si el plan todav√≠a est√° vigente (vence hoy o en el futuro)
                    if (fechaFinAnterior >= hoy) {
                        // Arrancamos el nuevo plan exactamente al d√≠a siguiente de que caduque el actual
                        fechaInicioCalculada = new Date(fechaFinAnterior);
                        fechaInicioCalculada.setDate(fechaInicioCalculada.getDate() + 1);
                    }
                }

                const nuevaFechaFin = new Date(fechaInicioCalculada);
                nuevaFechaFin.setDate(nuevaFechaFin.getDate() + diasDuracion);

                // PASO 2: "Apagar" todo el historial anterior marc√°ndolo como Inactivo
                const { error: errUpdate } = await miSupabase
                    .from('historial_suscripciones')
                    .update({ estado_pago: 'Inactivo' })
                    .eq('suscriptor_id', suscriptorId);
                    
                if (errUpdate) throw errUpdate;

                // PASO 3: Insertar la nueva suscripci√≥n con las fechas perfectas
                const { error: errInsert } = await miSupabase
                    .from('historial_suscripciones')
                    .insert([{
                        tenant_id: miTenantId,
                        suscriptor_id: suscriptorId,
                        plan_id: planId,
                        precio_cobrado: precioCobrado,
                        fecha_inicio: fechaInicioCalculada.toISOString().split('T')[0],
                        fecha_fin: nuevaFechaFin.toISOString().split('T')[0],
                        estado_pago: 'Pagado',
                        renovacion_automatica: renovacionAuto,
                        recordatorio_enviado: false
                    }]);

                if (errInsert) throw errInsert;

                alert(`üéâ ¬°Suscripci√≥n renovada!\nInicia: ${fechaInicioCalculada.toLocaleDateString('es-ES')}\nVence: ${nuevaFechaFin.toLocaleDateString('es-ES')}`);
                cerrarModalRenovar();
                
                // Refrescar la pantalla
                if (typeof cargarDatosYDashboard === 'function') await cargarDatosYDashboard();
                if (typeof cargarDashboardFinanciero === 'function') await cargarDashboardFinanciero();

            } catch (err) {
                console.error("Error renovando:", err);
                alert("‚ùå Ocurri√≥ un error al guardar: " + err.message);
            } finally {
                btn.innerHTML = textoOriginal; btn.disabled = false;
            }
        });

    </script>
</body>
</html>